@model IEnumerable<DCI.Models.ViewModel.UndertimeHeaderViewModel>
@using Newtonsoft.Json;
@using DCI.Core.Common;
@using DCI.Models.ViewModel;

<link href="~/css/DCIcustom.css" rel="stylesheet" />
<style>


    .custom-file-label {
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border-radius: 4px;
        cursor: pointer;
    }

    .file-name {
        margin-left: 10px;
        font-style: italic;
    }

</style>

@{
    var modulePageAccess = Context.Session.GetString("ModulePageAccess");

    var canView = false;
    var canAdd = false;
    var canEdit = false;
    var canDelete = false;
    var canExport = false;

    if (modulePageAccess == null)
    {
        <script>
            $.ajax({
                type: 'POST',
                url: '@Url.Action("Logout", "Account")',
                success: function (response) {

                    Swal.fire({
                        text: "Your session has timed out. Please log in again.",
                        icon: "info",
                        confirmButtonText: "Ok"
                    }).then((result) => {
                        window.location.href = '/Account/Logout';
                    });
                },
                error: function () {
                    Swal.fire({
                        text: "An error occurred. Please try again.",
                        icon: "error"
                    });
                }
            })
        </script>
    }
    else
    {
        var module = JsonConvert.DeserializeObject<List<ModuleInRoleViewModel>>(modulePageAccess)?
                        .FirstOrDefault(x => x.ModulePageId == (int)EnumModulePage.Undertime);
        canView = module?.View ?? false;
        canAdd = module?.Add ?? false;
        canEdit = module?.Update ?? false;
        canDelete = module?.Delete ?? false;
        canExport = module?.Export ?? false;
    }
}

<div class="container-fluid">
    <div class="spinner-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>



    <div class="d-sm-flex align-items-center justify-content-between mb-3">
        <h6 class="m-0 font-weight-bold text-gray-800">Reports</h6>
@* 
        <div class="upperRightDivBtn">

            <select id="statusDocType" name="statusDocType" class="form-select" onchange="loadData()">
                <option value="0">select all</option>
                @if (ViewBag.DocTypeList != null)
                {
                    @foreach (var item in ViewBag.DocTypeList)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                }
            </select>
        </div> *@

    </div>
    <div class="col-12 p0">
        <ul class="breadcrumb">
            <li><a href="~/Home/Index">Dashboard</a></li>
            <li><a href="~/Report/Index">Reports</a></li>
            <li>Undertime Summary Report</li>
        </ul>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header">
            <label class="mb0">Data</label>
        </div>
        <div class="card-body">
            <div class="table-responsive mt20">



                <table class="table table-bordered nowrap" id="tblUndertime" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            @* 	<th>
                            <label>Id</label>
                            </th> *@
                            <th>
                                <label>Request No</label>
                            </th>
                            <th>
                                <label>Date From</label>
                            </th>
                            <th>
                                <label>Date To</label>
                            </th>

                            <th>
                                <label>Deduction Date</label>
                            </th>
                            <th>
                                <label>Prepared By</label>
                            </th>

                            <th>
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    @item.RequestNo
                                </td>
                                <td>
                                    @item.DateFrom.ToShortDateString()
                                </td>
                                <td>
                                    @item.DateTo.ToShortDateString()
                                </td>
                                <td>
                                    @item.DateCreated.ToString("MM/dd/yyyy HH:mm tt")
                                </td>
                                <td>
                                    @item.CreatedName
                                </td>
                                <td class="text-center">
                                    @* <a href="#" onclick='view(@item.UndertimeHeaderId);' title="View" class="btn btn-primary"><i class="fas fa-search"></i></a> *@
                                    @* <a href="#" onclick='view(@item.UndertimeHeaderId);' title="View" class="btn btn-primary"><i class="fas fa-search"></i></a> *@
                                    <a asp-controller="Report" asp-action="UndertimeByEmpNo" asp-route-UndertimeHeaderId="@item.UndertimeHeaderId"
                                       asp-route-RequestNo="@item.RequestNo"  title="View" class="btn btn-primary"><i class="fas fa-search"></i></a>
                                </td>
                            </tr>
                        }
                    </tbody>

                </table>
            </div>
            </<div>
            </div>


            <div class="modal fade bd-example-modal-xl" id="undertimeModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static">
                <div class="modal-dialog modal-xl" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Undertime</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form id="undertimeInfo">
                            <div class="modal-body">
                                <table class="viewDetailsTbl table table-striped">
                                    <thead>
                                        <tr>

                                            <th>Employee No</th>
                                            <th>Name</th>
                                            <th>Deduction Type</th>
                                            <th>Date</th>
                                            <th>First In</th>
                                            <th>Last Out</th>
                                            <th>Total Working Hours</th>
                                            <th>Under Time</th>                                        
                                        </tr>
                                    </thead>
                                    <tbody id="underTable">
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal"><small>Close</small></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>


        </div>

        

@section scripts {

       

            <script type="text/javascript">
                var js = jQuery.noConflict(true);

                $('.spinner-overlay').show();

                setTimeout(() => {
                    $('.spinner-overlay').hide();
                }, 200);


                $(document).ready(function () {

                  //  loadData();

                    js('#tblUndertime').DataTable({
                    dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                    buttons: [
                        {
                            extend: 'excel',
                             text: 'Export to Excel',
                            title: 'Undertime Summary Report',
                            exportOptions: {
                                columns: ':not(:last-child)' // Excludes the last column
                            }
                        },
                        {
                            extend: 'pdf',
                             text: 'Export to PDF',
                            title: 'Undertime Summary Report',
                            exportOptions: {
                                columns: ':not(:last-child)' // Excludes the last column
                            }
                        }
                    ],
                    lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ], // Entries per page
                    pageLength: 10, 
                      order: [[3, 'desc']]
                    });


                      document.getElementById("statusDocType").addEventListener("change", function (event) {

                         loadData();
                      });
                 });



                //  function view(underHeaderId){
             
                //              $.ajax({
                //                     type: 'POST',
                //                     url: '@Url.Action("UndertimeDeductionByHeaderId", "Report")',
                //                     data: JSON.stringify({ UndertimeHeaderId: underHeaderId }),
                //                     contentType: 'application/json',
                //                     success: function (response) {
                //                         if (response.success) {
                //                             console.log(response.data);
                //                                            var table = $('#underTable');          // this is the <table>




                //                           var tbodytable = $("#underTable");
                //                             tbodytable.empty();

                //                           if (response.data.length > 0) {
                // // Group by Employee No
                // var grouped = {};
                // $.each(response.data, function (i, item) {
                //     if (!grouped[item.employeE_NO]) {
                //         grouped[item.employeE_NO] = [];
                //     }
                //     grouped[item.employeE_NO].push(item);
                // });

                // // Loop each employee group
                // $.each(grouped, function (empNo, records) {
                //     var totalUnderMinutes = 0;

                //     // Loop employee's records
                //     $.each(records, function (index, item) {
                //         totalUnderMinutes += timeToMinutes(item.undeR_TIME);

                //         var row = `<tr>
                //                       <td>${item.employeE_NO}</td>
                //                       <td>${item.name}</td>
                //                       <td>${item.deductionTypeName}</td>
                //                       <td>${item.date}</td>
                //                       <td>${item.firsT_IN}</td>
                //                       <td>${item.lasT_OUT}</td>
                //                       <td>${item.totaL_WORKING_HOURS}</td>
                //                       <td>${item.undeR_TIME}</td>
                                                                       
                //                    </tr>`;
                //         tbodytable.append(row);
                //     });

                //     // Add total row per employee
                //     var totalRow = `<tr class="table-secondary fw-bold">
                //                       <td colspan="7" class="text-end">Total Undertime (minutes) for ${empNo}</td>
                //                       <td>${totalUnderMinutes}</td>
                //                     </tr>`;


                //                     var valueX = convertMinutesToValue(totalUnderMinutes)

                //                    var totalRowInValue = `<tr class="table-secondary fw-bold">
                //                       <td colspan="7" class="text-end">Total Deduction for ${empNo}</td>
                //                       <td>${valueX}</td>
                //                     </tr>`;
                //     tbodytable.append(totalRow);
                //                tbodytable.append(totalRowInValue);
                // });




                    //      if ($.fn.DataTable.isDataTable('#underTable')) {
                    //                  js('#underTable').DataTable().destroy();
                                    
                    //      }

                    //  js('#underTable').DataTable({
                    // dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                    // buttons: [
                    //     {
                    //         extend: 'excel',
                    //         text: 'Excel',
                    //         title: 'Document Report',
                    //         exportOptions: {
                    //             columns: ':not(:last-child)' // Excludes the last column
                    //         }
                    //     },
                    //     {
                    //         extend: 'pdf',
                    //         text: 'PDF',
                    //         title: 'Document Report',
                    //         exportOptions: {
                    //             columns: ':not(:last-child)' // Excludes the last column
                    //         }
                    //     }
                    // ],
                    // lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ], // Entries per page
                    // pageLength: 10 // Default entries per page
                    // });




                                    
                //                     } else {
                //                         tbodytable.html(`<tr><td colspan="7" class="text-center">No record found.</td></tr>`);
                //                     }
                //                 }
                //             }
                // });

                                                 
                //     js('#undertimeModal').modal('show');
                //  }

                 function timeToMinutes(timeStr) {
                        if (!timeStr) return 0;
                        var parts = timeStr.split(":");
                        var hours = parseInt(parts[0]) || 0;
                        var mins = parseInt(parts[1]) || 0;
                        return hours * 60 + mins;
                    }

                                    function convertMinutesToValue(minutes) {
                    return Number((minutes / 480).toFixed(4));
                }

                function loadData() {

                       var doctype = document.getElementById("statusDocType").value;


                           $.ajax({
                                type: 'GET',
                                url: '@Url.Action("ReportDocTypeLoadData", "Report")',
                                data: { DocTypeId: doctype },
                                success: function (response) {
                                    if (response.success) {
                                      populateTable(response.data);

                                    } else {
                                        Swal.fire({
                                            text: response.message,
                                            icon: "error"
                                        });
                                    }
                                },
                                error: function () {
                                    Swal.fire({
                                        text: "An error occurred. Please try again.",
                                        icon: "error"
                                    });
                                }
                            });
                    }


                           function populateTable(data) {
                  if ($.fn.DataTable.isDataTable("#tblDocument")) {
                    // If DataTable exists, update data dynamically
                    var table = $("#tblDocument").DataTable();
                    table.clear().rows.add(data).draw();
                } else {
                    // Initialize DataTable with proper column definitions
                    js("#tblDocument").DataTable({
                        destroy: true,
                        dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                        buttons: [
                            {
                                extend: 'excel',
                                text: 'Excel',
                                title: 'Document Report',
                                exportOptions: {
                                    columns: ':visible' // Only export visible columns
                                }
                            },
                            {
                                extend: 'pdf',
                                text: 'PDF',
                                title: 'Document Report',
                                exportOptions: {
                                    columns: ':visible'
                                }
                            }
                        ],
                        data: data, // Set new data dynamically
                        columns: [
                            // { data: "docNo", title: "Document No" },
                            // { data: "docName", title: "Document Name" },
                            //    { data: "dateCreated", title: "Date Created" },
                            // { data: "docTypeName", title: "Document Type Name" },
                            // { data: "statusName", title: "Status" },
                            // { data: "requestByEmail", title: "Requested By" }
                                       { data: "docNo", title: "Document No" },
                            { data: "docName", title: "Document Name" },
                            { data: "docTypeName", title: "Document Type" },
                            { data: "statusName", title: "Status" },
                             { data: "dateCreatedString", title: "Date Created" },
                               { data: "requestByEmail", title: "Requested By" }
                        ],
                        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        pageLength: 10

                    });

                    //   const _export =  $('#canExport').val();

                    // if(_export == 0){
                    //         table.buttons(0).container().hide(); // Excel
                    //         table.buttons(1).container().hide(); // PDF
                    // }

                }
                }



            </script>
}
