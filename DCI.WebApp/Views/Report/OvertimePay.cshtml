@model IEnumerable<DCI.Models.ViewModel.OvertimePayReport>
@using Newtonsoft.Json;
@using DCI.Core.Common;
@using DCI.Models.ViewModel;

<link href="~/css/dcicustom.css" rel="stylesheet" />

@{
    var modulePageAccess = Context.Session.GetString("ModulePageAccess");
    var canView = false;
    var canAdd = false;
    var canEdit = false;
    var canDelete = false;

    if (modulePageAccess == null)
    {
        <script>
            $.ajax({
                type: 'POST',
                url: '@Url.Action("Logout", "Account")',
                success: function (response) {

                    Swal.fire({
                        text: "Your session has timed out. Please log in again.",
                        icon: "info",
                        confirmButtonText: "Ok"
                    }).then((result) => {
                        window.location.href = '/Account/Logout';
                    });
                },
                error: function () {
                    Swal.fire({
                        text: "An error occurred. Please try again.",
                        icon: "error"
                    });
                }
            })
        </script>
    }
    else
    {
        var module = JsonConvert.DeserializeObject<List<ModuleInRoleViewModel>>(modulePageAccess)?
                    .FirstOrDefault(x => x.ModulePageId == (int)EnumModulePage.Reports);
        canView = module?.View ?? false;
        canAdd = module?.Add ?? false;
        canEdit = module?.Update ?? false;
        canDelete = module?.Delete ?? false;
    }

}

<div class="container-fluid">
    <div class="spinner-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="d-sm-flex align-items-center justify-content-between mb-3">
        <h6 class="m-0 font-weight-bold text-gray-800">Overtime Summary Report</h6>
        <div class="upperRightDivBtn">
        </div>

    </div>

    <div class="col-12 p0">
        <ul class="breadcrumb">
            <li><a href="~/Home/Index">Dashboard</a></li>
            <li><a href="~/Report/Index">Report</a></li>
            <li><a href="#">Overtime Pay Report</a></li>
        </ul>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header">
            <label class="mb0">Data</label>
        </div>
        <div class="card-body">

            <div id="accordion">
                <form id="frmFilter" class="row">
                    <div class="form-group col-3">
                        <label class="frmText">Date Covered From: </label>
                        <div class="input-group">

                            <input type="text" name="minDate" id="minDate" class="form-control frmField" autocomplete="off">
                            <div class="input-group-prepend prependBtn">
                                <i class="fa fa-calendar"></i>
                            </div>
                            <label for="minDate" generated="true" class="error"></label>
                        </div>
                    </div>
                    <div class="form-group col-3">
                        <label class="frmText">Date Covered To: </label>
                        <div class="input-group">


                            <input type="text" name="maxDate" id="maxDate" class="form-control frmField" autocomplete="off">
                            <div class="input-group-prepend prependBtn">
                                <i class="fa fa-calendar"></i>
                            </div>
                            <label for="maxDate" generated="true" class="error"></label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="table-responsive mt20">
                <table class="table table-bordered" id="tblDTR">
                    <thead>
                        <tr>
                            <th style="width:7%">
                                <label>Date </label>
                            </th>
                            <th>
                                <label>Time In</label>
                            </th>
                            <th>
                                <label>Time Out</label>
                            </th>
                            <th>
                                <label>@DCI.Core.Common.Constants.OverTime_Regular</label>
                            </th>
                             <th>
                                <label>@DCI.Core.Common.Constants.OverTime_NightDifferential</label>
                            </th>
                            <th>
                                <label>@DCI.Core.Common.Constants.OverTime_SpecialHoliday</label>
                            </th>

                            <th>
                                <label>@DCI.Core.Common.Constants.OverTime_After8hrs</label>
                            </th>
                            <th>
                                <label>@DCI.Core.Common.Constants.OverTime_HolidayOnRestDay</label>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>

                                <td>
                                    @item.OTDateString
                                </td>
                                <td>
                                    @item.OTTimeFrom
                                </td>
                                <td>
                                    @item.OTTimeTo
                                </td>
                                <td>
                                    @item.Regular
                                </td>
                                     <td>
                                    @item.NightDifferential
                                </td>                               
                               <td>
                                    @item.SpecialHoliday
                                </td>

                                <td>
                                    @item.After8hrs
                                </td>
                                <td>
                                    @item.HolidayOnRestDay
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th></th> <!-- col 0 -->
                            <th></th> <!-- col 1 -->
                            <th style="text-align:right">TOTAL:</th> <!-- col 2 -->
                            <th></th> <!-- col 3 (Hours) -->
                            <th></th> <!-- col 4 (OT) -->
                            <th></th> <!-- col 5 (e.g., Action) -->
                            <th></th> <!-- col 5 (e.g., Action) -->
                            <th></th> <!-- col 5 (e.g., Action) -->
                        </tr>
                    </tfoot>
                </table>
            </div>
</<div>
</div>


            <div class="modal fade" id="createmodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Overtime</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form id="createForm">
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="frmText"><span class="required">*</span> Type</label>
                                    <select id="leaveTypeSelect" class="form-select" required onchange="GetLeaveTypeAmount()">
                                        <option value="0">Select</option>
                                        <option value="1">125% REGULAR (AFTER OFFICE HRS. /MON - FRI / EXCEPT HOLIDAY</option>
                                        <option value="2">10% NIGHT DIFFERENTIAL (10PM - 6AM) MON - SUN / HOLIDAY</option>
                                        <option value="3">130% SPECIAL HOLIDAY MON - SUN / SAT-SUN (FIRST 8 HRS.)</option>
                                        <option value="4">169% AFTER 8 HRS OF 130%</option>
                                        <option value="5">150% HOLIDAY ON REST DAY (SAT - SUN)</option>
                                    </select>


                                    <label class="frmText"><span class="required">*</span> Date: </label>
                                    <div class="input-group">
                                        <input type="text" name="OTDate" id="OTDate" class="form-control frmField" autocomplete="off">
                                        <div class="input-group-prepend prependBtn">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                    </div>
                                    <label for="OTDate" generated="true" class="error"></label>



                                    <label class="frmText"><span class="required">*</span> Time From: </label>
                                    <div class="input-group">
                                        <input type="text" name="OTTimeFrom" id="OTTimeFrom" class="form-control frmField" autocomplete="off">
                                        <div class="input-group-prepend prependBtn">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                    </div>
                                    <label for="OTTimeFrom" generated="true" class="error"></label>

                                    <label class="frmText"><span class="required">*</span> Time To: </label>
                                    <div class="input-group">
                                        <input type="text" name="OTTimeTo" id="OTTimeTo" class="form-control frmField" autocomplete="off">
                                        <div class="input-group-prepend prependBtn">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                    </div>
                                    <label for="OTTimeTo" generated="true" class="error"></label>

                                    @* <label class="frmText">Total: </label> *@
                                    <div id="totalTime"></div>
                                </div>




                                @*    <table class="viewDetailsTbl table table-striped">
                                    <tbody>                                     
                                    </tbody>
                                </table> *@
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal"><small>Close</small></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <style>
                #tblDTR th {
                    white-space: normal; /* allow wrapping */
                    word-wrap: break-word; /* break long words if needed */
                    max-width: 120px; /* optional: limit column width */
                    text-align: center; /* keep text centered */
                    vertical-align: middle;
                }
            </style>

@section scripts {

    

                <script type="text/javascript">
                            var js = jQuery.noConflict(true);
                                               let fromTime = null;
                        let toTime = null;

                                    $('.spinner-overlay').show();

                        setTimeout(() => {
                            $('.spinner-overlay').hide();
                        }, 200);


                            $(document).ready(function () {

                                   flatpickr("#minDate", {
                                   dateFormat: "Y-m-d",
                                   defaultDate: new Date()

                                });

                                  flatpickr("#maxDate", {
                                   dateFormat: "Y-m-d",
                                   defaultDate: new Date()
                                });

                                    // Create custom filtering function
                                   let min = null;
                                     let max = null;

                        js.fn.dataTable.ext.search.push(function (settings, data) {
                         min = $('#minDate').val();   // e.g. "2025-09-10"
                         max = $('#maxDate').val();   // e.g. "2025-09-20"
                        let date = (data[2] || '').trim(); // use correct column index! (2 = 3rd col)

                        if (!date) return false;
                        
                        if (min && date < min) return false;
                        if (max && date > max) return false;

                        return true;
                    });



                           var table =     js('#tblDTR').DataTable({
                                          dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                             buttons: [
                                 {
                                     extend: 'excel',
                                         text: 'Export to Excel',
                                     title: 'Overtime Summary Report',
                                     exportOptions: {
                                         columns: ':not(:last-child)' // Excludes the last column
                                     }
                                 },
                                 {
                                     extend: 'pdfHtml5',
                                     text: 'Export to PDF',
                                     title: 'Overtime Summary Report',
                                     orientation: 'landscape',
                                     exportOptions: {
                                         columns: ':not(:last-child)' // Excludes the last column
                                     },
                                 customize: function (doc) {


                                                                   doc.watermark = {
                                                                    text: 'Property of DBP Data Center, Inc.',   // watermark text
                                                                    color: 'red',
                                                                    opacity: 0.1,
                                                                    bold: true,
                                                                    italics: false
                                                                };


                                                                doc.content.splice(1, 0,
                                                                    {
                                                                        text: 'Period: ' + min + " to " + max,
                                                                        alignment: 'center',
                                                                        margin: [0, 0, 0, 4], // tighter spacing
                                                                        fontSize: 10,
                                                                        italics: true
                                                                    },
                                                                    {
                                                                        text: 'Employee Name: ' + '@Html.Raw(ViewBag.Fullname)', // dynamic from Razor
                                                                        alignment: 'center',
                                                                        margin: [0, 0, 0, 12],
                                                                        fontSize: 10,
                                                                        bold: true
                                                                    }
                                                                  );

                                                                                    doc.defaultStyle = {
                                                                                  fontSize: 9,       // smaller text
                                                                                  bold: false,
                                                                                  italics: false
                                                                                };
                                                                                 const tableObj = doc.content.find(c => c.table);
                                                                                    if (!tableObj) return; // nothing to do if no table found


                                                                                    const body = tableObj.table.body;
                                                                                    const colCount = body[0].length; // exported column count

                                                                                    // compute totals from DataTables API over ALL rows (or current page if you used modifier)
                                                                                    const api = table; // your DataTable instance
                                                                                    const intVal = i =>
                                                                                      typeof i === 'string'
                                                                                        ? (parseFloat(i.replace(/[\$,]/g, '')) || 0)
                                                                                        : (typeof i === 'number' ? i : 0);

                                                                                    // NOTE: update these indexes if your Hours/OT columns move after excluding columns
                                                                                    const totalA = api.column(3, { page: 'all' }).data()
                                                                                      .reduce((a, b) => intVal(a) + intVal(b), 0);

                                                                                    const totalB = api.column(4, { page: 'all' }).data()
                                                                                      .reduce((a, b) => intVal(a) + intVal(b), 0);
                                                                                   

                                                                                      //       const totalD = api.column(6, { page: 'all' }).data()
                                                                                      // .reduce((a, b) => intVal(a) + intVal(b), 0);

                                                                                    // Build a TOTAL row that matches the exported column count:
                                                                                    // We want totals in the last 2 columns, and a right-aligned label across the rest.
                                                                                    const labelSpan = Math.max(1, colCount - 2);
                                                                                    const fillerCells = Array(labelSpan - 1).fill({}); // fillers for the colSpan

                                                                                    const totalRow = [
                                                                                      { text: 'TOTAL', colSpan: labelSpan, alignment: 'right', bold: true },
                                                                                      ...fillerCells,
                                                                                      { text: totalA.toFixed(2), alignment: 'right', bold: true },
                                                                                      // { text: totalB.toFixed(2), alignment: 'right', bold: true },
                                                                                      
                                                                                      
                                                                                    ];

                                                                                    body.push(totalRow);

                                                                                                        tableObj.layout = {
                                                                                                      hLineWidth: function (i, node) { return 0.5; },   // horizontal line width
                                                                                                      vLineWidth: function (i, node) { return 0.5; },   // vertical line width
                                                                                                      hLineColor: function (i, node) { return '#000'; },// horizontal line color
                                                                                                      vLineColor: function (i, node) { return '#000'; },// vertical line color
                                                                                                      paddingLeft: function (i, node) { return 4; },    // cell padding
                                                                                                      paddingRight: function (i, node) { return 4; },
                                                                                                      paddingTop: function (i, node) { return 2; },
                                                                                                      paddingBottom: function (i, node) { return 2; }
                                                                                                    };


                                                                                    const jsDate = new Date().toLocaleString();
                                                                                doc.footer = function (currentPage, pageCount) {
                                                                                  return {
                                                                                    columns: [
                                                                                      { text: 'Date Printed: ' + jsDate, alignment: 'left', margin: [20, 0] },
                                                                                      { text: 'Page ' + currentPage + ' of ' + pageCount, alignment: 'right', margin: [0, 0, 20, 0] }   ,
                                                                                         { text: 'Prepared By: HR Department', alignment: 'center', margin: [0, 0] },
                                                                                    ],
                                                                                    margin: [20, 0]
                                                                                  };
                                                                                };
                                                            }
                                                        }
                                                    ],
                             lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ], // Entries per page
                             pageLength: 10 ,// Default entries per page

                                     order: [[2, 'desc']],
                                                                   footerCallback: function (row, data, start, end, display) {
                        let api = this.api();

                        let intVal = function (i) {
                            return typeof i === 'string'
                                ? parseFloat(i.replace(/[\$,]/g, '')) || 0
                                : typeof i === 'number' ? i : 0;
                        };

                        // Page totals (visible rows only)
                        let pageTotalHours = api
                            .column(3, { page: 'current' })
                            .data()
                            .reduce((a, b) => intVal(a) + intVal(b), 0);

                        let pageTotalOT = api
                            .column(4, { page: 'current' })
                            .data()
                            .reduce((a, b) => intVal(a) + intVal(b), 0);

                          let pageTotalC = api
                            .column(5, { page: 'current' })
                            .data()
                            .reduce((a, b) => intVal(a) + intVal(b), 0);

                                             let pageTotalD = api
                            .column(6, { page: 'current' })
                            .data()
                            .reduce((a, b) => intVal(a) + intVal(b), 0);

                        // Update footer cells
                        $(api.column(3).footer()).html(pageTotalHours.toFixed(2));
                        $(api.column(4).footer()).html(pageTotalOT.toFixed(2));
                                    $(api.column(5).footer()).html(pageTotalC.toFixed(2));
                                              $(api.column(6).footer()).html(pageTotalD.toFixed(2));
                    }
                                });


                                  $('#minDate, #maxDate').on('change', function () {
                                        table.draw();
                                    });


                                       flatpickr("#OTDate", {
                                                    enableTime: false,
                                                   dateFormat: "Y-m-d",
                                                        time_24hr: true,
                                                                     onChange: function(selectedDates, dateStr, instance) {
                                                      }
                                                });



                                                   flatpickr("#OTTimeFrom", {
                                                             enableTime: true,
                                                             noCalendar: true,
                                                              dateFormat: "H:i",
                                                              onChange: function(selectedDates) {
                                                              fromTime = selectedDates[0];
                                                              calculateDuration();
                                                            }
                                                        });

                                                       flatpickr("#OTTimeTo", {
                                                                 enableTime: true,
                                                         noCalendar: true,
                                                        dateFormat: "H:i",
                                                         onChange: function(selectedDates) {
                                                      toTime = selectedDates[0];
                                                      calculateDuration();
                                                    }
                                                });
                            });
                        

                    function calculateDuration() {
                          if (fromTime && toTime) {
                            // Set both times on the same day
                            const baseDate = new Date();
                            const from = new Date(baseDate);
                            from.setHours(fromTime.getHours(), fromTime.getMinutes(), 0, 0);

                            const to = new Date(baseDate);
                            to.setHours(toTime.getHours(), toTime.getMinutes(), 0, 0);

                            // Handle crossing midnight
                            if (to < from) {
                              to.setDate(to.getDate() + 1);
                            }

                            const diffMs = to - from;
                            const diffMins = Math.floor(diffMs / 60000);
                            const hours = Math.floor(diffMins / 60);
                            const minutes = diffMins % 60;

                            document.getElementById("totalTime").innerText =
                              `Total: ${hours} hour(s) and ${minutes} minute(s)`;
                          }
                        }

                            function newForm(dtr) {
                               // console.log(dtr)

                                  const timefrom = document.querySelector("#OTTimeFrom")._flatpickr;
                                                     timefrom.clear();
                                  const timeto = document.querySelector("#OTTimeTo")._flatpickr;
                                                                     timeto.clear();




                                    js('#createmodal').modal('show');
                            }





                </script>
}
