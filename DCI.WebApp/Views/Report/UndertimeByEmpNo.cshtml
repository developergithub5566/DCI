@model IEnumerable<DCI.Models.ViewModel.UndertimeDetailViewModel>
@using Newtonsoft.Json;
@using DCI.Core.Common;
@using DCI.Models.ViewModel;
@using System;
<link href="~/css/DCIcustom.css" rel="stylesheet" />

@{
    var modulePageAccess = Context.Session.GetString("ModulePageAccess");

    var canView = false;
    var canAdd = false;
    var canEdit = false;
    var canDelete = false;
    var canExport = false;

    if (modulePageAccess == null)
    {
        <script>
            $.ajax({
                type: 'POST',
                url: '@Url.Action("Logout", "Account")',
                success: function (response) {

                    Swal.fire({
                        text: "Your session has timed out. Please log in again.",
                        icon: "info",
                        confirmButtonText: "Ok"
                    }).then((result) => {
                        window.location.href = '/Account/Logout';
                    });
                },
                error: function () {
                    Swal.fire({
                        text: "An error occurred. Please try again.",
                        icon: "error"
                    });
                }
            })
        </script>
    }
    else
    {
        var module = JsonConvert.DeserializeObject<List<ModuleInRoleViewModel>>(modulePageAccess)?
                        .FirstOrDefault(x => x.ModulePageId == (int)EnumModulePage.Document);
        canView = module?.View ?? false;
        canAdd = module?.Add ?? false;
        canEdit = module?.Update ?? false;
        canDelete = module?.Delete ?? false;
        canExport = module?.Export ?? false;
    }
}

<div class="container-fluid">
@*     <div class="spinner-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div> *@



    <div class="d-sm-flex align-items-center justify-content-between mb-3">
        <h6 class="m-0 font-weight-bold text-gray-800">Reports</h6>
@* 
        <div class="upperRightDivBtn">

            <select id="statusDocType" name="statusDocType" class="form-select" onchange="loadData()">
                <option value="0">select all</option>
                @if (ViewBag.DocTypeList != null)
                {
                    @foreach (var item in ViewBag.DocTypeList)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                }
            </select>
        </div> *@

    </div>
    <div class="col-12 p0">
        <ul class="breadcrumb">
            <li><a href="~/Home/Index">Dashboard</a></li>
           <li><a href="~/Report/Index">Report</a></li>
               <li><a href="~/Report/Undertime">Undertime</a></li>
              <li>@ViewBag.RequestNo</li>
        </ul>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header">
            <label class="mb0">Undertime - @ViewBag.RequestNo</label>
        </div>
        <div class="card-body">
            <div class="table-responsive mt20">



                <table class="table table-bordered nowrap" id="tblUndertime" width="100%" cellspacing="0">
                    <thead>
                        <tr>

                            <th>Employee No</th>
                            <th>Name</th>
                            <th>Deduction Type</th>
                            <th>Date</th>
                            <th>First In</th>
                            <th>Last Out</th>
                            <th>Total Working Hours</th>
                            <th>Under Time</th>
                        </tr>
                    </thead>
                   
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            var grouped = Model.GroupBy(x => new { x.EMPLOYEE_NO });

                            foreach (var g in grouped)
                            {
                                foreach (var record in g)
                                {
                                    <tr>
                                        <td>@record.EMPLOYEE_NO</td>
                                        <td>@record.NAME</td>
                                        <td>@record.DeductionTypeName</td>
                                        <td>@record.DATE.ToString("yyyy-MM-dd")</td>
                                        <td>@record.FIRST_IN</td>
                                        <td>@record.LAST_OUT</td>
                                        <td>@record.TOTAL_WORKING_HOURS</td>
                                        <td>@record.UNDER_TIME.ToString()</td>
                                    </tr>
                                }

                                // compute total undertime in minutes
                             var totalMinutes = g.Sum(r => 
                                {
                                    TimeSpan ts;
                                    if (TimeSpan.TryParse(r.UNDER_TIME, out ts))
                                    {
                                        return ts.Hours * 60 + ts.Minutes; // exclude seconds
                                    }
                                    return 0;
                                });


                                // convert to hh:mm if you prefer
                                var totalTime = TimeSpan.FromMinutes(totalMinutes);
                                 var undertimeVal = Math.Round((decimal)totalMinutes / 480m, 4);
                                
                            
                                <tr class="table-secondary fw-bold">
                                    <td colspan="7" class="text-end">Total Undertime (minutes) for  @g.Key.EMPLOYEE_NO </td>
                                    <td>@totalTime.ToString(@"hh\:mm")</td>
                                </tr>

                                
                                <tr class="table-secondary fw-bold">
                                    <td colspan="7" class="text-end">Total Deduction for  @g.Key.EMPLOYEE_NO </td>
                                    <td>@undertimeVal.ToString()</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center">No record found.</td>
                            </tr>
                        }
                    </tbody>
@* 
                    <tbody>
                        @foreach (var grp in Model.GroupBy(x => new { x.EMPLOYEE_NO, x.NAME }))
                        {
                            foreach (var r in grp)
                            {
                                <tr>
                                    <td>@r.EMPLOYEE_NO</td>
                                    <td>@r.NAME</td>
                                    <td>@r.DATE.ToString("yyyy-MM-dd")</td>
                                    <td>@r.FIRST_IN</td>
                                    <td>@r.LAST_OUT</td>
                                    <td>@r.TOTAL_WORKING_HOURS</td>
                                    <td>@r.UNDER_TIME</td>
                                </tr>
                            }

                            var totalMinutes = grp.Sum(r => TimeSpan.TryParse(r.UNDER_TIME, out var ts) ? (int)ts.TotalMinutes : 0);

                            <!-- Summary row: exactly 7 TDs -->
                            <tr class="group-total table-secondary fw-bold">
                                <td>**Total for @grp.Key.EMPLOYEE_NO**</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>@totalMinutes</td>
                            </tr>
                        }
                    </tbody> *@

                </table>
            </div>
            </<div>
            </div>
        </div>
        
@section scripts {

            <script src="https://cdn.datatables.net/2.1.2/js/dataTables.js"></script>
            
            @*  Export Button*@
            <script src="https://cdn.datatables.net/buttons/3.2.1/js/dataTables.buttons.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
            <script src="https://cdn.datatables.net/buttons/3.2.1/js/buttons.html5.min.js"></script>
            <script src="https://cdn.datatables.net/buttons/3.2.1/js/buttons.print.min.js"></script>
            <script src="https://cdn.datatables.net/searchpanes/2.3.3/js/dataTables.searchPanes.js"></script>
            <script src="https://cdn.datatables.net/searchpanes/2.3.3/js/searchPanes.dataTables.js"></script>

            <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.css">
            <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.1/css/buttons.dataTables.css">

            <script type="text/javascript">
                var js = jQuery.noConflict(true);

                $('.spinner-overlay').show();

                setTimeout(() => {
                    $('.spinner-overlay').hide();
                }, 200);


                $(document).ready(function () {

                        // setTimeout(() => {
                        //     $('.spinner-overlay').hide();
                        // }, 200);


                     // js('#tblUndertime').DataTable({
                     //                  dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                     //     buttons: [
                     //         {
                     //            extend: 'print',
                     //                customScripts: [
                     //                    'https://unpkg.com/pagedjs/dist/paged.polyfill.js'
                     //                ]
                     //         }
                     //     ],
                     //     lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ], // Entries per page
                     //     pageLength: 10 ,// Default entries per page
                     //            // order: [[2, 'desc']]
                     //        });

                //                   const dt = $('#tblUndertime').DataTable({
                //   dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rtip',
                //   buttons: [
                //     {
                //       extend: 'excelHtml5',
                //       text: 'Excel'
                //       // If you want to EXCLUDE summary rows from export, uncomment:
                //       // , exportOptions: { rows: (idx, data, node) => !$(node).hasClass('group-total') }
                //     }
                //   ],
                //   ordering: false,          // keep grouped order stable
                //   autoWidth: false,
                //   responsive: true
                // });


                
                 });
              


                           function populateTable(data) {
                  if ($.fn.DataTable.isDataTable("#tblDocument")) {
                    // If DataTable exists, update data dynamically
                    var table = $("#tblDocument").DataTable();
                    table.clear().rows.add(data).draw();
                } else {
                    // Initialize DataTable with proper column definitions
                    js("#tblDocument").DataTable({
                        destroy: true,
                        dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                        buttons: [
                            {
                                extend: 'excel',
                                text: 'Excel',
                                title: 'Document Report',
                                exportOptions: {
                                    columns: ':visible' // Only export visible columns
                                }
                            },
                            {
                                extend: 'pdf',
                                text: 'PDF',
                                title: 'Document Report',
                                exportOptions: {
                                    columns: ':visible'
                                }
                            }
                        ],
                        data: data, // Set new data dynamically
                        columns: [
                            // { data: "docNo", title: "Document No" },
                            // { data: "docName", title: "Document Name" },
                            //    { data: "dateCreated", title: "Date Created" },
                            // { data: "docTypeName", title: "Document Type Name" },
                            // { data: "statusName", title: "Status" },
                            // { data: "requestByEmail", title: "Requested By" }
                                       { data: "docNo", title: "Document No" },
                            { data: "docName", title: "Document Name" },
                            { data: "docTypeName", title: "Document Type" },
                            { data: "statusName", title: "Status" },
                             { data: "dateCreatedString", title: "Date Created" },
                               { data: "requestByEmail", title: "Requested By" }
                        ],
                        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        pageLength: 10

                    });

                    //   const _export =  $('#canExport').val();

                    // if(_export == 0){
                    //         table.buttons(0).container().hide(); // Excel
                    //         table.buttons(1).container().hide(); // PDF
                    // }

                }
                }



            </script>
}
