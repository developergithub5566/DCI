@* @model IEnumerable<DCI.Models.ViewModel.DocumentViewModel>*@
@using Newtonsoft.Json;
@using DCI.Core.Common;
@using DCI.Models.ViewModel;

<link href="~/css/DCIcustom.css" rel="stylesheet" />
<style>


    .custom-file-label {
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border-radius: 4px;
        cursor: pointer;
    }

    .file-name {
        margin-left: 10px;
        font-style: italic;
    }

</style>

@{
    var modulePageAccess = Context.Session.GetString("ModulePageAccess");

    var canView = false;
    var canAdd = false;
    var canEdit = false;
    var canDelete = false;
    var canExport = false;

    if (modulePageAccess == null)
    {
        <script>
            $.ajax({
                type: 'POST',
                url: '@Url.Action("Logout", "Account")',
                success: function (response) {

                    Swal.fire({
                        text: "Your session has timed out. Please log in again.",
                        icon: "info",
                        confirmButtonText: "Ok"
                    }).then((result) => {
                        window.location.href = '/Account/Logout';
                    });
                },
                error: function () {
                    Swal.fire({
                        text: "An error occurred. Please try again.",
                        icon: "error"
                    });
                }
            })
        </script>
    }
    else
    {
        var module = JsonConvert.DeserializeObject<List<ModuleInRoleViewModel>>(modulePageAccess)?
                        .FirstOrDefault(x => x.ModulePageId == (int)EnumModulePage.Document);
        canView = module?.View ?? false;
        canAdd = module?.Add ?? false;
        canEdit = module?.Update ?? false;
        canDelete = module?.Delete ?? false;
        canExport = module?.Export ?? false;
    }
}

<div class="container-fluid">
    <div class="spinner-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>



    <div class="d-sm-flex align-items-center justify-content-between mb-3">
        <h6 class="m-0 font-weight-bold text-gray-800">Reports</h6>

        <div class="upperRightDivBtn">
            @*        <a href="#" title="Add Document" class="btn btnPrimary btn-icon-split @(canAdd ? "" : "disabled")" data-toggle="modal" data-target="#" onclick="newForm()">
            <span class="icon text-white"><i class="fa-solid fa-plus text-xs"></i></span>
            <span class="text text-white"><small>Add Document</small></span>
            </a> *@
            @*    <label for="DocTypeId" class="col-form-label required">Document Type:</label> *@

            @*  <input type="text" id="customSearch" class="form-control" placeholder="Search..."> *@
            <select id="statusSelect" class="form-select" onchange="loadData()">
                <option value="0">select all</option>
                <option value="3">In Progress</option>
                <option value="4">For Review</option>
                <option value="6">For Approval</option>
                <option value="7">Approved</option>
            </select>
        </div>

    </div>
    <div class="col-12 p0">
        <ul class="breadcrumb">
            <li><a href="~/Home/Index">Dashboard</a></li>
            <li>Report</li>
        </ul>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header">
            <label class="mb0">Data</label>
        </div>
        <div class="card-body">
            <div class="table-responsive mt20">



                <table class="table table-bordered nowrap" id="tblDocument" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            @* 	<th>
                            <label>Id</label>
                            </th> *@
                            <th>
                                <label>Document No</label>
                            </th>
                            <th>
                                <label>Document Name</label>
                            </th>
                            <th>
                                <label>Document Type</label>
                            </th>

                            <th>
                                <label>Status</label>
                            </th>

                            <th>
                                <label>Date Created</label>
                            </th>
                            <th>
                                <label>Requested By</label>
                            </th>
                            @* <th>
                            Action
                            </th> *@
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        @*  @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    @item.DocNo
                                </td>
                                <td class="col-2">

                                    <span class="d-inline-block text-truncate" style="width: 200px;" title="@item.DocName">
                                        @item.DocName
                                    </span>
                                </td>
                                <td>
                                    @item.DocTypeName
                                </td>
                                <td>
                                    @item.DateCreated
                                </td>
                                <td>
                                    @item.StatusName
                                </td>
                                <td>
                                    @item.CreatedName
                                </td>

                            </tr>
                        } *@
                    </tbody>

                </table>
            </div>
            </<div>
            </div>


        </div>
        @section scripts {

            <script src="https://cdn.datatables.net/2.1.2/js/dataTables.js"></script>

            <script src="https://cdn.datatables.net/buttons/3.2.1/js/dataTables.buttons.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
            <script src="https://cdn.datatables.net/buttons/3.2.1/js/buttons.html5.min.js"></script>
            <script src="https://cdn.datatables.net/buttons/3.2.1/js/buttons.print.min.js"></script>
            <script src="https://cdn.datatables.net/searchpanes/2.3.3/js/dataTables.searchPanes.js"></script>
            <script src="https://cdn.datatables.net/searchpanes/2.3.3/js/searchPanes.dataTables.js"></script>

            @*          <script src="https://cdn.datatables.net/select/3.0.0/js/dataTables.select.js"></script>
            <script src="https://cdn.datatables.net/select/3.0.0/js/select.dataTables.js"></script> *@

            <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.css">
            <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.1/css/buttons.dataTables.css">


            @*           <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.css">
            <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.3.3/css/searchPanes.dataTables.css">
            <link rel="stylesheet" href="https://cdn.datatables.net/select/3.0.0/css/select.dataTables.css"> *@

            <script type="text/javascript">
                var js = jQuery.noConflict(true);

                $('.spinner-overlay').show();

                setTimeout(() => {
                    $('.spinner-overlay').hide();
                }, 200);


                $(document).ready(function () {

                    loadData();

                    // js('#tblDocument').DataTable({
                    // dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                    // buttons: [
                    //     {
                    //         extend: 'excel',
                    //         text: 'Excel',
                    //         title: 'Document Report',
                    //         exportOptions: {
                    //             columns: ':not(:last-child)' // Excludes the last column
                    //         }
                    //     },
                    //     {
                    //         extend: 'pdf',
                    //         text: 'PDF',
                    //         title: 'Document Report',
                    //         exportOptions: {
                    //             columns: ':not(:last-child)' // Excludes the last column
                    //         }
                    //     }
                    // ],
                    // lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ], // Entries per page
                    // pageLength: 10 // Default entries per page
                    // });


                      document.getElementById("statusSelect").addEventListener("change", function (event) {

                         loadData();
                      });
                 });


                function loadData() {

                       var statusId = document.getElementById("statusSelect").value;


                           $.ajax({
                                type: 'GET',
                                url: '@Url.Action("ReportStatusLoadData", "Report")',
                                data: { StatusId: statusId },
                                success: function (response) {
                                    if (response.success) {
                                      populateTable(response.data);

                                    } else {
                                        Swal.fire({
                                            text: response.message,
                                            icon: "error"
                                        });
                                    }
                                },
                                error: function () {
                                    Swal.fire({
                                        text: "An error occurred. Please try again.",
                                        icon: "error"
                                    });
                                }
                            });
                    }


                           function populateTable(data) {
                  if ($.fn.DataTable.isDataTable("#tblDocument")) {
                    // If DataTable exists, update data dynamically
                    var table = $("#tblDocument").DataTable();
                    table.clear().rows.add(data).draw();
                } else {
                    // Initialize DataTable with proper column definitions
                    js("#tblDocument").DataTable({
                        destroy: true,
                        dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                        buttons: [
                            {
                                extend: 'excel',
                                text: 'Excel',
                                title: 'Document Report',
                                exportOptions: {
                                    columns: ':visible' // Only export visible columns
                                }
                            },
                            {
                                extend: 'pdf',
                                text: 'PDF',
                                title: 'Document Report',
                                exportOptions: {
                                    columns: ':visible'
                                }
                            }
                        ],
                        data: data, // Set new data dynamically
                        columns: [
                            // { data: "docNo", title: "Document No" },
                            // { data: "docName", title: "Document Name" },
                            //    { data: "dateCreated", title: "Date Created" },
                            // { data: "docTypeName", title: "Document Type Name" },
                            // { data: "statusName", title: "Status" },
                            // { data: "requestByEmail", title: "Requested By" }
                                       { data: "docNo", title: "Document No" },
                            { data: "docName", title: "Document Name" },
                            { data: "docTypeName", title: "Document Type" },
                            { data: "statusName", title: "Status" },
                             { data: "dateCreatedString", title: "Date Created" },
                               { data: "requestByEmail", title: "Requested By" }
                        ],
                        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        pageLength: 10                           

                    });

                    //   const _export =  $('#canExport').val();

                    // if(_export == 0){
                    //         table.buttons(0).container().hide(); // Excel
                    //         table.buttons(1).container().hide(); // PDF
                    // }

                }
                }



            </script>
        }
