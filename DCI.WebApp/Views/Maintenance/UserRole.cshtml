@model IEnumerable<DCI.Models.ViewModel.UserInRoleViewModel>
@using Newtonsoft.Json;
@using DCI.Core.Common;
@using DCI.Models.ViewModel;

<link href="~/css/dcicustom.css" rel="stylesheet" />

<style>


	.ulAction {
		min-width: 100px;
		padding-left: 0px;
		margin-bottom: 0px;
	}

		.ulAction > li {
			display: inline-block;
		}

			.ulAction > li .btn {
				font-size: 14px;
			}

	.userRoleDiv {
		text-align: center;
	}

		.userRoleDiv i.roleIcon {
			font-size: 80px;
			display: block;
			margin-bottom: 10px;
			color: #b1b1b1;
		}

		.userRoleDiv label.title {
			font-size: 20px;
			font-weight: 600;
			color: black;
		}

		.userRoleDiv ul.descList {
			padding-left: 0px;
		}

			.userRoleDiv ul.descList li {
				display: inline-block;
			}

				.userRoleDiv ul.descList li + li:before {
					padding: 3px;
					color: #c9c9c9;
					content: "|";
				}

				.userRoleDiv ul.descList li label {
					font-size: 12px;
					color: black;
				}

				.userRoleDiv ul.descList li span {
					font-weight: 600;
				}

</style>
@{
	var modulePageAccess = Context.Session.GetString("ModulePageAccess");

	var module = JsonConvert.DeserializeObject<List<ModuleInRoleViewModel>>(modulePageAccess)?
						.FirstOrDefault(x => x.ModulePageId == (int)EnumModulePage.UserRole);
	var canView = module?.View ?? false;
	var canAdd = module?.Add ?? false;
	var canEdit = module?.Update ?? false;
	var canDelete = module?.Delete ?? false;
}

<div class="container-fluid">
	<div class="spinner-overlay">
		<div class="spinner-border text-light" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
	</div>
	<div class="d-sm-flex align-items-center justify-content-between mb-3">
		<h6 class="m-0 font-weight-bold text-gray-800">User Role</h6>
		<div class="upperRightDivBtn">
			@* 	<a href="#" class="btn btnPrimary btn-icon-split" data-toggle="modal" data-target="#" onclick="newForm()">
			<span class="icon text-white"><i class="fa-solid fa-plus text-xs"></i></span>
			<span class="text text-white"><small>Add Department</small></span>
			</a> *@
			<a asp-controller="Maintenance" asp-action="RoleModule" asp-route-id="0" asp-route-type="0" class="btn btn-primary @(canAdd ? "" : "disabled")">
				<span class="icon text-white"><i class="fa-solid fa-plus text-xs"></i></span>
				<span class="text text-white"><small>Add User Role</small></span>

			</a>
		</div>

	</div>
	<div class="col-12 p0">
		<ul class="breadcrumb">
			<li><a href="~/Home/Index">Dashboard</a></li>
			<li><a href="~/Maintenance/Index">Administration</a></li>
			<li>User Role</li>
		</ul>
	</div>



	<div class="row">
		@foreach (var userrole in Model)
		{
			<div class="col-xl-4 col-md-6">
				<div class="card shadow mb-4">
					<div class="card-body userRoleDiv">
						<i class="fa-solid fa-circle-user roleIcon text-gray-300"></i>
						<label class="title">@userrole.RoleName</label>
						<ul class="descList">
							<li><label>Users: <span>@userrole.UserCount</span></label></li>
							<li><label>Module Access: <span>@userrole.ModuleCount</span></label></li>
							@* 	<li><label>Submodule Access: <span>@userrole.SubModuleCount</span></label></li> *@
						</ul>
						<ul class="ulAction">

							<li>
								<a asp-controller="Maintenance" asp-action="RoleModule" asp-route-id="@userrole.RoleId"  asp-route-type="1" class="btn btn-primary @(canView ? "" : "disabled")"><i class="fas fa-search"></i></a>
							</li>
							<li>
								<a asp-controller="Maintenance" asp-action="RoleModule" asp-route-id="@userrole.RoleId"  asp-route-type="0" class="btn btn-info  @(canEdit ? "" : "disabled") "><i class="fa fa-edit"></i></a>
							</li>
							<li>
								<a href="#" id="deleteform" onclick="deleteform(@userrole.RoleId)" class="btn btn-danger @(canDelete ? "" : "disabled")"><i class="far fa-trash-alt"></i></a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		}
	</div>
</div>

@section scripts {
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"></script>
	<script type="text/javascript">
		$('.spinner-overlay').show();

		setTimeout(() => {
			$('.spinner-overlay').hide();
		}, 200);


		$(document).ready(function () {

		});

		function deleteform(id) {

			Swal.fire({
				text: "Are you sure you want to delete this record?",
				icon: "warning",
				showCancelButton: true,
				confirmButtonText: "Yes, delete it!"
			}).then((result) => {
				if (result.isConfirmed) {
					$.ajax({
						type: 'POST',
						url: '@Url.Action("DeleteUserRole", "Maintenance")',
						data: { id: id },
						success: function (response) {
							if (response.success) {
								Swal.fire({
									text: response.message,
									icon: "success",
									confirmButtonText: "Ok"
								}).then((result) => {
									location.reload();
								});
							} else {
								Swal.fire({
									text: response.message,
									icon: "error"
								});
							}
						},
						error: function () {
							Swal.fire({
								text: "An error occurred. Please try again.",
								icon: "error"
							});
						}
					});
				}
			});
		}

		function editForm(id, view) {
			$.ajax({
				type: 'POST',
				url: '@Url.Action("EditSection", "Maintenance")',
				data: { SectionId: id },
				success: function (response) {
					if (response.success) {
						$('#SectionId').val(response.data.sectionId);
						$('#SectionCode').val(response.data.sectionCode);
						$('#SectionName').val(response.data.sectionName);
						$('#Description').val(response.data.description);

						var $select = $('#departmentSelect');
						$select.empty();
						$select.append('<option value="">Select type</option>');

						$.each(response.data.optionsDepartment, function (index, item) {
							if (item.value == response.data.departmentId) {
								$select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
							} else {
								$select.append('<option value="' + item.value + '">' + item.text + '</option>');
							}
						});

						if (view == 1) {	//View button
							$('#createForm').find('input, select, textarea').prop('disabled', true);
							$('#btnSave').hide();
						}
						else {  //Edit button
							$('#createForm').find('input, select, textarea').prop('disabled', false);
							$('#btnSave').show();
						}

						js('#createmodal').modal('show');
					} else {
						Swal.fire({
							text: response.message,
							icon: "error"
						});
					}
				},
				error: function () {
					Swal.fire({
						text: "An error occurred. Please try again.",
						icon: "error"
					});
				}
			});
		}
	</script>
}
