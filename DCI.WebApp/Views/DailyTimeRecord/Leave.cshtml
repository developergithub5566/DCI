@model DCI.Models.ViewModel.LeaveViewModel
@using Newtonsoft.Json;
@using DCI.Core.Common;
@using DCI.Models.ViewModel;


<link href="~/css/DCIcustom.css" rel="stylesheet" />




<!-- Begin Page Content -->
<div class="container-fluid">
    <div class="spinner-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="d-sm-flex align-items-center justify-content-between mb-3">
        <h6 class="m-0 font-weight-bold text-gray-800">Leave Application & Balances</h6>
        <div class="upperRightDivBtn">
          
            <a href="#" title="Request Leave" class="btn btnPrimary btn-icon-split" data-toggle="modal" data-target="#" onclick="newForm()">
                <span class="icon text-white"><i class="fa-solid fa-plus text-xs"></i></span>
                <span class="text text-white"><small>File Request</small></span>
            </a>
        </div>
    </div>
    <div class="col-12 p0">
        <ul class="breadcrumb">
            <li><a href="~/Home/Index">Dashboard</a></li>
            <li>Leave Application</li>
        </ul>
    </div>

    <div class="row">
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card shadow h-100 text-dark">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2" style="padding-left: 3px;">
                            <div class="text-xs font-weight-bold text-primary mb-1">
                                <span class="text-uppercase"> Vacation Leave</span> <br>
                                <small class="text-secondary">(Remaining Balance)</small>
                            </div>
                            <div class="h3 mb-0 font-weight-bold text-dark" >@Model.VLBalance</div>
                        </div>
                        <div class="col-auto">
                   
                            <i class="fa-solid fa-plane fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card shadow h-100 text-dark">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2" style="padding-left: 3px;">
                            <div class="text-xs font-weight-bold text-primary mb-1">
                                <span class="text-uppercase"> Sick Leave</span> <br>
                                <small class="text-secondary">(Remaining Balance)</small>
                            </div>
                            <div class="h3 mb-0 font-weight-bold text-dark" >@Model.SLBalance</div>
                        </div>
                        <div class="col-auto">
                            <i class="fa-solid fa-temperature-high fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card shadow h-100 text-dark">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2" style="padding-left: 3px;">
                            <div class="text-xs font-weight-bold text-primary mb-1">
                                <span class="text-uppercase"> SPECIAL LEAVE</span> <br>
                                <small class="text-secondary">(Remaining Balance)</small>
                            </div>
                            <div class="h3 mb-0 font-weight-bold text-dark" style="padding-left: 3px;">@Model.SPLBalance</div>
                        </div>
                        <div class="col-auto">
                            <i class="fa-solid fa-tree-city fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card shadow h-100 text-dark">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2" style="padding-left: 3px;">
                            <div class="text-xs font-weight-bold text-primary mb-1">
                                <span class="text-uppercase"> WELLNESS LEAVE</span> <br>
                                <small class="text-danger font-weight-bold">(Remaining Balance)</small>
                            </div>
                            <div class="h3 mb-0 font-weight-bold text-dark" style="padding-left: 3px;">@Model.WELLBalance</div>
                        </div>
                        <div class="col-auto">
                            <i class="fa-solid fa-child fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-12">
            <div class="card shadow mb-4">
                <!-- Card Header -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0  small font-weight-bold text-gray-800">Data</h6>
                </div>

                <!-- Card Body -->
                <div class="card-body">
                    <div id="accordion">
                        <form id="frmFilter" class="row">
                            <div class="form-group col-3">
                                <label class="frmText">Date Covered From: </label>
                                <div class="input-group">

                                    <input type="text" name="minDate" id="minDate" class="form-control frmField" autocomplete="off">
                                    <div class="input-group-prepend prependBtn" id="calendarIconFrom">
                                        <i class="fa fa-calendar"></i>
                                    </div>
                                    <label for="minDate" generated="true" class="error"></label>
                                </div>
                            </div>
                            <div class="form-group col-3">
                                <label class="frmText">Date Covered To: </label>
                                <div class="input-group">


                                    <input type="text" name="maxDate" id="maxDate" class="form-control frmField" autocomplete="off">
                                    <div class="input-group-prepend prependBtn" id="calendarIconTo">
                                        <i class="fa fa-calendar"></i>
                                    </div>
                                    <label for="maxDate" generated="true" class="error"></label>
                                </div>
                            </div>
                        </form>
                    </div>


                    <div class="table-responsive mt20">
                        <table class="table table-bordered dataTable" width="100%" cellspacing="0" id="tblLeave">
                            <thead>
                                <tr>
                                    <th><span>Request No.</span></th>                              
                                    <th><span>Leave Type</span></th>
                                    <th><span>Date Filed</span></th>
                                    <th><span>Date Covered</span></th>
                                    <th width="10%"><span>No. of Days</span></th>
                                    <th width="10%"><span>Status</span></th>
                                    <th><span>Action</span></th>
                                </tr>
                            </thead>
                            <tbody>

                                @foreach (var hdr in Model.LeaveRequestHeaderList)
                                {
                                    string statusClass = hdr.Status switch
                                    {
                                        (int)EnumStatus.Approved => "btn-primary",
                                        (int)EnumStatus.ForApproval => "btn-success",
                                        (int)EnumStatus.Rejected => "btn-danger",
                                        (int)EnumStatus.Cancelled => "btn-secondary",
                                        (int)EnumStatus.VLDeducted
                                        or (int)EnumStatus.PayrollDeducted => "btn-warning",
                                        _ => "btn-dark"
                                    };

                                    <tr>
                                        <td><strong>@hdr.RequestNo</strong></td>                                     
                                        <td>@hdr.LeaveName</td>
                                        <td>@hdr.DateFiled.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td>
                                            <strong>
                                                @foreach (var dtl in hdr.LeaveRequestDetailList)
                                                {
                                                    <span class='d-inline-block mb-1 border applicationStatus bg-light text-dark text-xs'>@dtl.LeaveDate.ToShortDateString()</span>
                                                }
                                            </strong>
                                        </td>
                                        <td><strong>@hdr.NoofDays</strong></td>
                                        <td class="text-center">
                                            <strong>
                                                <span class="@statusClass applicationStatus">@hdr.StatusName</span>
                                            </strong>
                                        </td>
                                        <td class="text-center">
                                            <a href="javascript:void(0)" onclick="editForm(@hdr.LeaveRequestHeaderId)" title="View" class="btn btn-primary"><i class="fas fa-search"></i></a>

                                            @if (hdr.Status == (int)EnumStatus.ForApproval)
                                            {
                                                <a href="javascript:void(0)" onclick="cancel(@hdr.LeaveRequestHeaderId)" title="Cancel Request" class="btn btn-secondary"><i class="fas fa-ban"></i></a>
                                            }                                          
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-12">
            <div class="card shadow mb-4">
                <!-- Card Header -->
        @*         <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0  small font-weight-bold text-gray-800">Data</h6>
                </div> *@
                <!-- Card Body -->
                <div class="card-body">
                    <div id="accordion">

                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="frmText"><span class="required">*</span> Year</label>

                                <select id="yearSelect" class="form-select" asp-items="@(new SelectList(Model.YearList))" onchange="getLeaveByYear()">
                                    <option value="">select year</option>
                                    Model.vlSummaries
                                </select>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
        @{
            var currentMonth = DateTime.Now.ToString("MMM-yyyy"); // e.g. "Sep-2025"
        }
        <div class="col-xl-6">

            <div class="card shadow mb-4">
                <!-- Card Header -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0  small font-weight-bold text-gray-800">Vacation Leave</h6>
                </div>

                <!-- Card Body -->
                <div class="card-body">

                    <div class="table-responsive">
                        <table class="table table-bordered text-dark text-xs" width="100%" cellspacing="0">
                            <thead class="bg-light">
                                <tr>
                                    <th><span>As of</span></th>
                                    <th><span>Beg bal</span></th>
                                    <th><span>Credit</span></th>
                                    <th><span>Availed</span></th>
                                    <th><span>VL Mon</span></th>
                                    <th><span>End Bal</span></th>
                                </tr>
                            </thead>
                            <tbody id="tblVL">
                                @{
                                    decimal totalCreditVL = 0;
                                    decimal totalAvailedVL = 0;
                                    decimal totalMonetizedVL = 0;
                                }
                                @foreach (var vl in Model.vlSummaries)
                                {
                                    string rowClass = vl.AsOf == currentMonth ? "table-success" : "";

                                    totalCreditVL += vl.Credit;
                                    totalAvailedVL += vl.Availed;
                                    totalMonetizedVL += vl.Monetized;


                                    <tr class='@rowClass'>
                                        <td><strong> @vl.AsOf  </strong></td>
                                        <td><strong>  @vl.BegBal</strong></td>
                                        <td>@vl.Credit</td>
                                        <td><strong>@vl.Availed</strong></td>
                                        <td><strong>@vl.Monetized</strong></td>
                                        <td>@vl.EndBal</td>
                                    </tr>
                                }

                                <tr style="font-weight: bold;">
                                    <td></td>
                                    <td></td>
                                    <td>@totalCreditVL.ToString("N4")</td>
                                    <td>@totalAvailedVL.ToString("N4")</td>
                                    <td>@totalMonetizedVL.ToString("N4")</td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-6">
            <div class="card shadow mb-4">
                <!-- Card Header -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0  small font-weight-bold text-gray-800">Sick Leave</h6>
                </div>

                <!-- Card Body -->
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered text-dark text-xs" width="100%" cellspacing="0">
                            <thead class="bg-light">
                                <tr>
                                    <th><span>As of</span></th>
                                    <th><span>Beg bal</span></th>
                                    <th><span>Credit</span></th>
                                    <th><span>Availed</span></th>
                                    <th><span>SL Mon</span></th>
                                    <th><span>End Bal</span></th>
                                </tr>
                            </thead>
                            <tbody id="tblSL">
                                @{
                                    decimal totalCreditSL = 0;
                                    decimal totalAvailedSL = 0;
                                    decimal totalMonetizedSL = 0;
                                }
                                @foreach (var sl in Model.slSummaries)
                                {                                 
                                    string rowClass = sl.AsOf == currentMonth ? "table-success" : "";

                                    totalCreditSL += sl.Credit;
                                    totalAvailedSL += sl.Availed;
                                    totalMonetizedSL += sl.Monetized;

                                    <tr class='@rowClass'>
                                        <td><strong> @sl.AsOf  </strong></td>
                                        <td><strong>  @sl.BegBal</strong></td>
                                        <td>@sl.Credit</td>
                                        <td><strong>@sl.Availed</strong></td>
                                        <td><strong>@sl.Monetized</strong></td>
                                        <td>@sl.EndBal</td>
                                    </tr>
                                }
                                <tr style="font-weight: bold;">
                                    <td></td>
                                    <td></td>
                                    <td>@totalCreditSL.ToString("N4")</td>
                                    <td>@totalAvailedSL.ToString("N4")</td>
                                    <td>@totalMonetizedSL.ToString("N4")</td>
                                    <td></td>
                                </tr>
                             
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createmodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Request Form</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="createForm">
                <div class="modal-body">
             
                        <input type="hidden" id="SelectedDatesJson" name="SelectedDates" />
                        <input type="hidden" id="dateSelected" name="dateSelected" />
                        <input type="hidden" id="hiddenSPLBalance" name="hiddenSPLBalance" value="0" />
                        <input type="hidden" id="hiddenVLBalance" name="hiddenVLBalance" value="0" />
                        <input type="hidden" id="hiddenSLBalance" name="hiddenSLBalance" value="0" />
                        <input type="hidden" id="hiddenWellBalance" name="hiddenWellBalance" value="0" />
                        <input type="hidden" id="SelectedLeaveTypeAmount" name="SelectedLeaveTypeAmount" value="0" />
                        <input type="hidden" id="preloadedDates" />
                        <input type="hidden" id="isMultiple" name="isMultiple" value="1">

                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="frmText"><span class="required">*</span> Type</label>
                                <select id="leaveTypeSelect" class="form-select" required onchange="GetLeaveTypeAmount()" required>
                                    <option value="0" disabled>select type</option>
                                </select>

                            </div>
                        </div>

                        <div class="col-lg-12" id="hiddenDatePicker">
                            <div class="form-group" id="datepickerDate">
                                <label class="frmText"><span class="required">*</span> Period Covered: </label>
                                <div class="input-group">
                                    <input type="text" name="COVERED_DATE" id="dateCovered" class="form-control frmField" autocomplete="off" required>
                                    <div class="input-group-prepend prependBtn" id="calendarIconId">
                                        <i class="fa fa-calendar"></i>
                                    </div>
                                </div>
                                <label for="dateCovered" generated="true" class="error"></label>
                            </div>

                            <div class="form-group" id="datepickerLabel">
                                <label class="frmText"><span class="required">*</span> Period Covered: </label>
                                <div class="input-group">

                                    @*  <span class='d-inline-block mb-1 border applicationStatus bg-light text-dark text-xs'>June 24 2025</span> *@
                                    <div id="dateContainer"></div>

                                </div>
                                <label for="dateCovered" generated="true" class="error"></label>
                            </div>

                        </div>

                        <div class="col-lg-6">
                            <div class="form-group">
                                <label class="frmText"><span class="required">*</span> No. of Days</label>
                                @*  <input type="number" min="0" step="any" name="NO_DAYS" class="form-control frmField" autocomplete="off"> *@
                               @*  <input type="text" step="any" id="NoOfDays" name="NoOfDays" class="form-control frmField" autocomplete="off" onkeypress="return isNumericDecimalKey(event,this);"> *@
                                <input type="text" id="NoOfDays" name="NoOfDays" class="form-control frmField" autocomplete="off" onkeypress="return isNumericDecimalKey(event, this)" oninput="checkingNumber(this)" />
                            </div>
                        </div>

                    

                        <div class="col-12">
                            <div class="form-group">
                                <label class="frmText"><span class="required">*</span> Reason:</label>
                                <textarea class="form-control frmField" name="Reason" id="Reason" required></textarea>
                            </div>
                        </div>
                        <div class="col-12">
                            <hr>
                            <div class="form-group">
                                <label class="frmText" id="ApproverLabel"> </label><br>
                                <label class="font-weight-bold mb0 text-danger" id="deptHeadName"></label>
                                 <label class="d-block mt0 text-left text-xs" id="ApprovalDate"></label>
                                <label class="d-block mt0 text-left text-xs" id="ApprovalRemarks"></label>
                       @*          <label class="d-block mt0 text-left text-xs">(Department Head)</label> *@
                            </div>
                        </div>
              
                </div>
                <div class="modal-footer pt0">
                    <div id="btnSubmit">
                        <button class="btn btnPrimary btn-icon-split d-block" type="submit" >
                            <span class="icon text-white">
                                    <i class="fa-regular fa-paper-plane text-xs"></i>
                            </span>
                            <span class="text text-white"><small>Submit </small></span>
                        </button>
                    </div>
                    <div id="btnCancel">
              @*           <button class="btn btnDanger btn-icon-split d-block" type="button" onclick="cancel()">
                            <span class="icon text-white">
                                <i class="fa-regular fa-file-lines text-xs"></i>
                            </span>
                            <span class="text text-white"><small>Cancel Request</small></span>
                        </button> *@
                    </div>
                    <button class="btn btnSecondary btn-icon-split d-block" data-dismiss="modal">
                        <span class="icon text-white">
                            <i class="fa-solid fa-xmark text-xs"></i>
                        </span>
                        <span class="text text-white"><small>Close </small></span>
                    </button>

                </div>
                      </form>
            </div>
        </div>
    </div>

</div>

@section scripts {


    <script src="~/js/dci-validation.js"></script>


@* 

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
        // console.log("bypass-" + urlParams);
            const id = urlParams.get('leaveId');
            if (id) {
                editForm(id);
            }
        });
    </script>

 *@

    <script type="text/javascript">
                         var js = jQuery.noConflict(true);
                         $('.spinner-overlay').show();

                         setTimeout(() => {
                             $('.spinner-overlay').hide();
                         }, 200);

                         let fp;

                        $(document).ready(function () {
                          //  GetLeaveTypeAmount();
                                $('#calendarIconId').on('click', function () {
                          $('#dateCovered').trigger('click');
                        });
                        $('#calendarIconFrom').on('click', function () {
                   $('#minDate').trigger('click');
        });
          $('#calendarIconTo').on('click', function () {
                   $('#maxDate').trigger('click');
        });



                            let firstDayOfMonth = new Date();
                            firstDayOfMonth.setDate(1);

                                      flatpickr("#minDate", {
                                     dateFormat: "Y-m-d",
                                        defaultDate: (function () {
                                    let d = new Date();
                                   // d.setMonth(d.getMonth() - 1);
                                     d.setMonth(d.getMonth() - 12);
                                    return d;
                                     })()
                                });

                                    flatpickr("#maxDate", {
                                     dateFormat: "Y-m-d",
                                     defaultDate: new Date()
                                  });

                                          let min = null;
                                     let max = null;
                                 js.fn.dataTable.ext.search.push(function (settings, data) {
                                     min = $('#minDate').val();   // e.g. "2025-09-01"
                                     max = $('#maxDate').val();   // e.g. "2025-09-10"
                                    let rawDateTime = (data[2] || '').trim(); // adjust index to your date column
                                    // rawDateTime = "2025-09-09 15:45"

                                    if (!rawDateTime) return false;

                                    // Parse row datetime
                                    let rowDate = new Date(rawDateTime.replace(' ', 'T'));
                                    // "2025-09-09 15:45" → "2025-09-09T15:45" → valid ISO date

                                    // Parse min/max (flatpickr gives YYYY-MM-DD)
                                    let minDate = min ? new Date(min + "T00:00:00") : null;
                                    let maxDate = max ? new Date(max + "T23:59:59") : null;

                                    if (minDate && rowDate < minDate) return false;
                                    if (maxDate && rowDate > maxDate) return false;
                                               
                                    return true;
                                });
               

                       

                          let table =    js('#tblLeave').DataTable({
                                        dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                         buttons: [                            
                             {
                                 extend: 'pdf',
                                 text: 'Export to PDF',
                                 title: 'Leave Report',
                                 exportOptions: {
                                     columns: ':not(:last-child)' // Excludes the last column
                                 },
                                customize: function (doc) {
                                                                 doc.watermark = {
                                                                    text: 'Property of DBP Data Center, Inc.',   // watermark text
                                                                    color: 'red',
                                                                    opacity: 0.1,
                                                                    bold: true,
                                                                    italics: false
                                                                };

                                                                doc.content.splice(1, 0,
                                                                    {
                                                                        text: 'Period: ' + min + " to " + max,
                                                                        alignment: 'center',
                                                                        margin: [0, 0, 0, 4], // tighter spacing
                                                                        fontSize: 10,
                                                                        italics: true
                                                                    },
                                                                    {
                                                                        text: 'Prepared by: ' + '@Html.Raw(ViewBag.Fullname)', // dynamic from Razor
                                                                        alignment: 'center',
                                                                        margin: [0, 0, 0, 12],
                                                                        fontSize: 10,
                                                                        bold: true
                                                                    }
                                                                          );

                                    // Footer with Date Printed + Page count
                                    var now = new Date();
                                    var jsDate = now.toLocaleString();

                                    doc['footer'] = function (currentPage, pageCount) {
                                        return {
                                            columns: [
                                                { text: 'Date Printed: ' + jsDate, alignment: 'left', margin: [20, 0] },
                                                { text: 'Page ' + currentPage.toString() + ' of ' + pageCount, alignment: 'right', margin: [0, 0, 20, 0] }
                                            ],
                                            margin: [20, 0]
                                        };
                                    };
                                }
                            }
                        ],
                         lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ], // Entries per page
                         pageLength: 10 ,// Default entries per page
                                 order: [[2, 'desc']]
                              });
                                // Event listener for date inputs
                        $('#minDate, #maxDate').on('change', function () {
                            table.draw();
                        });                                                             


                             let nodays = 0.0000;

                                                               
                                                            fp =    flatpickr("#dateCovered", {
                                                                           mode: "multiple",                                                                         
                                                                           enableTime: false,
                                                                           dateFormat: "Y-m-d",     
                                                                           onChange: function(selectedDates, dateStr, instance) {
                                                                          const leaveTypeId = $('#leaveTypeSelect').val();
                                                                           console.log("leavetype");
                                                                          console.log(leaveTypeId);
                                                                          if(leaveTypeId == 16){
                                                                                    // Allow single date
                                                                                   if (selectedDates.length < 3) return;

                                                                                        // Sort dates
                                                                                        selectedDates.sort((a, b) => a - b);

                                                                                        const oneDay = 24 * 60 * 60 * 1000;

                                                                                        // Check for any 3 consecutive dates
                                                                                        for (let i = 0; i < selectedDates.length - 2; i++) {
                                                                                            const d1 = selectedDates[i];
                                                                                            const d2 = selectedDates[i + 1];
                                                                                            const d3 = selectedDates[i + 2];

                                                                                            const diff1 = (d2 - d1) / oneDay;
                                                                                            const diff2 = (d3 - d2) / oneDay;

                                                                                            if (diff1 === 1 && diff2 === 1) {
                                                                                                // Remove the last selected date
                                                                                                selectedDates.pop();
                                                                                                instance.setDate(selectedDates, false);
                                                                                                return;
                                                                                            }
                                                                                        }
                                                                          }


                                                                             let nodays = selectedDates.length;
                                                                            
                                                                                    let amount =     $('#SelectedLeaveTypeAmount').val();                                                                           

                                                                          let total = amount * nodays;
                                                                     
                                                                         let formattedDays = total.toFixed(4);

                                                                             //2025-12-02
                                                                             // let leave =  $('#leaveTypeSelect').val();

                                                                             // if(leave == 5){ //SPL leavetype
                                                                             //   const spl =   $('#hiddenSPLBalance').val();

                                                                             //   if(parseFloat(formattedDays) > parseFloat(spl)){
                                                                             //                console.log(spl);
                                                                             //                console.log(formattedDays);
                                                                             //                    Swal.fire({
                                                                             //                        text: "You cannot file a special leave that exceeds your remaining special leave balance.",
                                                                             //                        icon: "warning",
                                                                             //                        confirmButtonText: "Ok"
                                                                             //                    }).then((result) => {
                                                                             //                           fp.clear();
                                                                             //                    });
                                                                             //    }
                                                                             // }


                                                                             $('#NoOfDays').val(formattedDays);

                                                                             let selectedDateStrings = selectedDates.map(date =>
                                                                               instance.formatDate(date, "Y-m-d")
                                                                             );                                                                                  

                                                                             $('#SelectedDatesJson').val(JSON.stringify(selectedDateStrings));
                                                                           }
                                                                         });

                                                                                 GetLeaveTypeAmount();
                                                                         $('#leaveTypeSelect').on('change', GetLeaveTypeAmount);


                  $('#createForm').submit(function (event) {
                      event.preventDefault();

                       $(this).find(':submit').prop('disabled', true);


                   const leaveTypeId = $('#leaveTypeSelect').val();
                     const selectedDatesJson = $('#SelectedDatesJson').val();

                   

                         const noOfDays = $('#NoOfDays').val();
                           const reason = $('#Reason').val();

                             const formData = new FormData();
                            formData.append('LeaveTypeId', leaveTypeId);
                             formData.append('NoOfDays', noOfDays);
                              formData.append('SelectedDateJson', selectedDatesJson);

                               formData.append('Reason', reason);

                                                                                        const noOfDaysX = parseFloat(noOfDays) || 0; // ensure it's numeric
                                                                                        let  _noofdaysX = parseFloat(noOfDaysX.toFixed(4));
                                                                             if (leaveTypeId == 5) { // SPL leave type
                                                                                    const spl = parseFloat($('#hiddenSPLBalance').val()) || 0;                                                         

                                                                                    if ( _noofdaysX > spl) {                                                                                       

                                                                                        Swal.fire({
                                                                                            text: "You cannot file a special leave that exceeds your remaining special leave balance.",
                                                                                            icon: "warning",
                                                                                            confirmButtonText: "Ok"
                                                                                      }).then((result) => {
                                                                                                       $('#createForm').find(':submit').prop('disabled', false)
                                                                                                });
                                                                                        return;;
                                                                                    }
                                                                              }else if( leaveTypeId == 9){ //vl monetized
                                                                                  

                                                                                    const vl = parseFloat($('#hiddenVLBalance').val()) || 0;
                                                                                    _noofdaysX = _noofdaysX + 1;
                                                                                    if ( _noofdaysX > vl) {
                                                                                        Swal.fire({
                                                                                            text: "You cannot file monetization that exceeds your remaining leave balance. Please ensure at least one day of leave remains after monetization.",
                                                                                            icon: "warning",
                                                                                            confirmButtonText: "Ok"
                                                                                         }).then((result) => {
                                                                                                       $('#createForm').find(':submit').prop('disabled', false)
                                                                                                });
                                                                                         
                                                                                        return;;
                                                                                    }
                                                                              }else if( leaveTypeId == 10){ //sl monetized
                                                                        

                                                                                    const sl = parseFloat($('#hiddenSLBalance').val()) || 0;
                                                                                    _noofdaysX = _noofdaysX + 1;
                                                                                    if ( _noofdaysX > sl) {
                                                                                        Swal.fire({
                                                                                            text: "You cannot file monetization that exceeds your remaining leave balance. Please ensure at least one day of leave remains after monetization.",
                                                                                            icon: "warning",
                                                                                            confirmButtonText: "Ok"
                                                                                       }).then((result) => {
                                                                                                       $('#createForm').find(':submit').prop('disabled', false)
                                                                                                });
                                                                                        return;;
                                                                                    }
                                                                             }else if( leaveTypeId == 16){ //wellness


                                                                                    const sl = parseFloat($('#hiddenWellBalance').val()) || 0;
                                                                                    _noofdaysX = _noofdaysX + 1;
                                                                                    if ( _noofdaysX > sl) {
                                                                                        Swal.fire({
                                                                                            text: "You cannot file a wellness leave that exceeds your remaining wellness leave balance.",
                                                                                            icon: "warning",
                                                                                            confirmButtonText: "Ok"
                                                                                       }).then((result) => {
                                                                                                       $('#createForm').find(':submit').prop('disabled', false)
                                                                                                });
                                                                                        return;;
                                                                                    }
                                                                              }

                                                                              
                                                                              if(selectedDatesJson == "[]" && (leaveTypeId != 9 && leaveTypeId != 10) ){
                                                                                   
                                                                                    Swal.fire({
                                                                                            text: "Please select the date covered.",
                                                                                            icon: "warning",
                                                                                            confirmButtonText: "Ok"
                                                                                       }).then((result) => {
                                                                                                       $('#createForm').find(':submit').prop('disabled', false)
                                                                                                });
                                                                                        return;;
                                                                              }

                                                                              if(noOfDaysX == 0){
                                                                                    Swal.fire({
                                                                                            text: "Please enter the number of days.",
                                                                                            icon: "warning",
                                                                                            confirmButtonText: "Ok"
                                                                                       }).then((result) => {
                                                                                                       $('#createForm').find(':submit').prop('disabled', false)
                                                                                                });
                                                                                        return;
                                                                              }

                  Swal.fire({
                      text: "Are you sure you want to submit this record?",
                      icon: "question",
                      showCancelButton: true,
                      confirmButtonText: "Ok"
                  }).then((result) => {
                      if (result.isConfirmed) {
                          $('.spinner-overlay').show();

                          $.ajax({
                              type: 'POST',
                              url: '@Url.Action("SaveLeave", "DailyTimeRecord")',
                              data: formData,
                                  processData: false,
                                     contentType: false,
                              success: function (response) {
                                  if (response.success) {
                                
                                      // $('#createForm')[0].reset();
                                      // js('#createmodal').modal('hide');
                                         $('.spinner-overlay').show();

                                      Swal.fire({
                                          text: response.message,
                                          icon: "success",
                                          confirmButtonText: "Ok"
                                      }).then((result) => {
                                                //  $('#createForm').find(':submit').prop('disabled', false);
                                          location.reload();
                                      });

                                  } else {
                                      Swal.fire({
                                          text: response.message,
                                          icon: "error"
                                      });
                                  }
                                  $('.spinner-overlay').hide();
                              },
                              error: function () {
                                    $('#createForm').find(':submit').prop('disabled', false);
                                  $('.spinner-overlay').hide();
                                  Swal.fire({
                                      text: "An error occurred. Please try again.",
                                      icon: "error"
                                  });
                              }
                          });
                      }
                      else{
                             $(this).find(':submit').prop('disabled', false);
                      }
                  });


              }); //submit
                           }); //end doc

                    function newForm() {
                       const my_fp = document.querySelector("#dateCovered")._flatpickr;
                                       my_fp.clear();
                                   let nodays = 0.0000;
                                 $('#NoOfDays').val(nodays.toFixed(4));
                             $('#Reason').val('');
                                   $('#datepickerDate').show();
                                  $('#datepickerLabel').hide();
                               $('#btnCancel').hide();
                                 $('#btnSubmit').show();
                                   document.getElementById('ApprovalDate').textContent = '';
                                       document.getElementById('ApprovalRemarks').textContent = '';


                          $.ajax({
                              type: 'POST',
                              url: '@Url.Action("RequestLeave", "DailyTimeRecord")',
                              success: function (response) {
                                  if (response.success) {
                                        document.getElementById('deptHeadName').textContent = response.data.approverHead;
                                        document.getElementById('ApproverLabel').textContent = 'For Approval of:';
                                      $('#createForm').find('input, select, textarea').prop('disabled', false);

                                 var $select = $('#leaveTypeSelect');
                                  $select.empty();
                                  $select.append('<option value="0" disabled>Select leave type</option>');

                                  $.each(response.data.optionsLeaveType, function (index, item) {
                                 if (item.value == response.data.leaveRequestHeader.leaveTypeId) {
                                          $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                      } else {
                                          $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                      }
                                  });

                            // console.log(response);

                          // $('#dateCovered').val(response.data.selectedDateJson);
                            $('#NoOfDays').val(response.data.leaveRequestHeader.noofDays);
                                 $('#Reason').val(response.data.leaveRequestHeader.reason);
                             //  const spl =   response.data.leaveRequestHeader.splBalance;
                               $('#hiddenSPLBalance').val((response?.data?.leaveRequestHeader?.splBalance || 0).toFixed(4));

                               $('#hiddenSLBalance').val((response?.data?.leaveRequestHeader?.slBalance || 0).toFixed(4));
                               $('#hiddenVLBalance').val((response?.data?.leaveRequestHeader?.vlBalance || 0).toFixed(4));
                                $('#hiddenWellBalance').val((response?.data?.leaveRequestHeader?.wellBalance || 0).toFixed(4));
                            


                                 $('#NoOfDays').prop('disabled', true);
                                              $('#createForm').find(':submit').prop('disabled', false);
                                      js('#createmodal').modal('show');
                                  } else {
                                      Swal.fire({
                                          text: response.message,
                                          icon: "error"
                                      });
                                  }
                                  $('.spinner-overlay').hide();
                              },
                              error: function () {
                                  $('.spinner-overlay').hide();
                                  Swal.fire({
                                      text: "An error occurred. Please try again.",
                                      icon: "error"
                                  });
                              }
                          });

                     js('#createmodal').modal('show');

                    }

                     function editForm(leaveHdrId) {
                                 $('#datepickerDate').hide();
                                    $('#datepickerLabel').show();
                                 const my_fp = document.querySelector("#dateCovered")._flatpickr;
                                          if (typeof my_fp !== "undefined") {
                                           my_fp.clear();
                                          }

                                  let nodays = 0.0000;
                                  $('#NoOfDays').val(nodays.toFixed(4));
                                  $('#Reason').val('');
                              
                                    const formData = new FormData();
                                  formData.append('LeaveRequestHeaderId', leaveHdrId);


                         $.ajax({
                             type: 'POST',
                             url: '@Url.Action("RequestLeave", "DailyTimeRecord")',
                             data: formData,
                             processData: false,
                             contentType: false,
                             success: function (response) {
                                 if (response.success) {

                                 var $select = $('#leaveTypeSelect');
                                     $select.empty();
                                     $select.append('<option value="0" disabled>Select type</option>');

                                     $.each(response.data.optionsLeaveType, function (index, item) {
                                 if (item.value == response.data.leaveRequestHeader.leaveTypeId) {
                                         $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                     } else {
                                         $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                     }
                                 });

                                    console.log(response);

                                   var container = $('#dateContainer'); // Make sure you have this container in your HTML
                                      container.empty(); // Clear previous spans
                                                                                 
                                                  response.data.leaveDateList.forEach(function (date) {
                                                  var span = `<span class='d-inline-block mb-1 border applicationStatus bg-light text-dark text-xs'>${date}</span>`;
                                                  container.append(span);
                                              });



                                           //$('#dateCovered').val(response.data.selectedDateJson);
                                          $('#NoOfDays').val(response.data.leaveRequestHeader.noofDays);
                                                 $('#Reason').val(response.data.leaveRequestHeader.reason);

                                            $('#btnCancel').hide();

                                                document.getElementById('ApproverLabel').textContent = '';
                                                              document.getElementById('ApprovalDate').textContent = '';
                                       document.getElementById('ApprovalRemarks').textContent = '';
                                         document.getElementById('deptHeadName').textContent = '';

                                   if(response.data.leaveRequestHeader.status == @((int)EnumStatus.ForApproval)){  //forapproval
                                                $('#btnCancel').show();
                                                 $('#btnSubmit').hide();
                                                     document.getElementById('deptHeadName').textContent = response.data.approverHead;
                                                       document.getElementById('ApproverLabel').textContent = 'For Approval of:';
                                              }
                                else if(response.data.leaveRequestHeader.status == @((int)EnumStatus.Approved)){     //approved
                                               $('#btnSubmit').hide();
                                                   $('#btnCancel').hide();
                                                         document.getElementById('deptHeadName').textContent = response.data.approverHead;
                                                            document.getElementById('ApproverLabel').textContent = 'Approved By:';                                                           
                                                       document.getElementById('ApprovalDate').textContent = 'Approved Date and Time: ' + response.data.leaveRequestHeader.dateApprovedDisapproved;
                                    }
                                         else if(response.data.leaveRequestHeader.status == @((int)EnumStatus.Rejected)){     //Rejected
                                                $('#btnSubmit').hide();
                                                    $('#btnCancel').hide();
                                                          document.getElementById('deptHeadName').textContent = response.data.approverHead;
                                                            document.getElementById('ApproverLabel').textContent = 'Rejected By:';                                                           
                                            document.getElementById('ApprovalRemarks').textContent = 'Remarks: ' + response.data.leaveRequestHeader.approvalRemarks;
                                                       document.getElementById('ApprovalDate').textContent = 'Rejected Date and Time: ' + response.data.leaveRequestHeader.dateApprovedDisapproved;
                                     }
                                       else if(response.data.leaveRequestHeader.status == @((int)EnumStatus.VLDeducted) || response.data.leaveRequestHeader.status == @((int)EnumStatus.PayrollDeducted)){     //Deducted
                                                $('#btnSubmit').hide();
                                                    $('#btnCancel').hide();
                                                          document.getElementById('deptHeadName').textContent = 'HR Processed Undertime Deduction';
                                                            document.getElementById('ApproverLabel').textContent = 'Deducted By:';

                                                                   
                                     }
                                       else if(response.data.leaveRequestHeader.status == @((int)EnumStatus.Cancelled)  && response.data.leaveRequestHeader.dateModified != null){     //canclled
                                                $('#btnSubmit').hide();
                                                    $('#btnCancel').hide();
                                                                      let iso =  response.data.leaveRequestHeader.dateModified;
                                                       let formatted = iso.split(".")[0].replace("T", " ").slice(0, 16);
                                                      document.getElementById('ApprovalDate').textContent = 'Cancelled Date: ' + formatted;
                                     }
                                      


                           //  $('#preloadedDates').val(response.data.leaveRequestHeader.selectedDateJson);

                          let preloaded = response.data.selectedDateJson;
                                

                                   let fp = flatpickr("#dateCovered", {
                                          mode: "multiple",
                                           dateFormat: "Y-m-d"
                                        });
                                 
                                       console.log(preloaded);
                                       fp.setDate(preloaded);
                                            $('#createForm').find('input, select, textarea').prop('disabled', true);
                                     js('#createmodal').modal('show');
                                 } else {
                                     Swal.fire({
                                         text: response.message,
                                         icon: "error"
                                     });
                                 }
                                 $('.spinner-overlay').hide();
                                       
                             },
                             error: function () {
                                 $('.spinner-overlay').hide();
                                 Swal.fire({
                                     text: "An error occurred. Please try again.",
                                     icon: "error"
                                 });
                             }
                         });

                    js('#createmodal').modal('show');

                   }


                       function cancel(id){
                                Swal.fire({
                                    text: "Are you sure you want to cancel this request?",
                                    icon: "warning",
                                    showCancelButton: true,
                                    confirmButtonText: "Yes, cancel it!"
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        $.ajax({
                                            type: 'POST',
                                            url: '@Url.Action("CancelLeave", "DailyTimeRecord")',
                                            data: { LeaveRequestHeaderId: id },
                                            success: function (response) {
                                                if (response.success) {
                                                    Swal.fire({
                                                        text: response.message,
                                                        icon: "success",
                                                        confirmButtonText: "Ok"
                                                    }).then((result) => {
                                                        location.reload();
                                                    });
                                                } else {
                                                    Swal.fire({
                                                        text: response.message,
                                                        icon: "error"
                                                    });
                                                }
                                            },
                                            error: function () {
                                                Swal.fire({
                                                    text: "An error occurred. Please try again.",
                                                    icon: "error"
                                                });
                                            }
                                        });
                                    }
                                });
                    }


       

               function GetLeaveTypeAmount(){
                     let leave =  $('#leaveTypeSelect').val();
           
                     let  _amount = 0.0000;
                      let mode = 'multiple';
                    
                      
                      $('#NoOfDays').prop('disabled', true);
                      $('#hiddenDatePicker').show();
                     if(leave == null){
                                  _amount = 0.5000;
                       $('#SelectedLeaveTypeAmount').val(_amount);
                           $('#isMultiple').val(0);
                             mode = 'single';
                           
                     }
                   else if(leave == 1 || leave == 2 || leave == 15){ //half day SLVL

                       _amount = 0.5000;
                       $('#SelectedLeaveTypeAmount').val(_amount);
                           $('#isMultiple').val(0);
                              mode = 'single';

                    } else if(leave == 5 ){ //SPL 

                        _amount = 1.0000;
                       $('#SelectedLeaveTypeAmount').val(_amount);
                       $('#isMultiple').val(1);
                              fp.set('mode', 'multiple');
                          mode = 'multiple';
                               $('#NoOfDays').prop('disabled', false);
                    }   else if(leave == 9 || leave == 10){ //VLSL Monetized

                        _amount = 1.0000;
                       $('#SelectedLeaveTypeAmount').val(_amount);
                       $('#isMultiple').val(1);
                              fp.set('mode', 'multiple');
                          mode = 'multiple';
                               $('#NoOfDays').prop('disabled', false);
                                       $('#hiddenDatePicker').hide();
                    }else{
                        _amount = 1.0000;
                       $('#SelectedLeaveTypeAmount').val(_amount);
                       $('#isMultiple').val(1);
                              fp.set('mode', 'multiple');
                          mode = 'multiple';
                    }             

                        if(fp){
                            fp.set('mode', mode);
                            fp.clear();
                        }                        
                 }



      
                        

                       function isNumericDecimalKey(evt, el) {
                            const k = evt.key; // more reliable than keyCode for modern browsers

                            // Allow navigation/edit keys
                            if (k === 'Backspace' || k === 'Tab' || k === 'ArrowLeft' || k === 'ArrowRight' || k === 'Home' || k === 'End') {
                                return true;
                            }

                            // Allow only digits
                            if (k >= '0' && k <= '9') return true;

                            // Allow a single decimal point (not as the first char)
                            if (k === '.') {
                                if (el.value.length === 0) { evt.preventDefault(); return false; }
                                if (el.value.indexOf('.') === -1) return true;
                                evt.preventDefault();
                                return false;
                            }

                            // Block everything else (e, E, -, +, spaces, etc.)
                            evt.preventDefault();
                            return false;
                        }                       


         function getLeaveByYear() {

           
                  var _year = document.getElementById("yearSelect").value;
                 
                    $.ajax({
                              type: 'POST',
                              url: '@Url.Action("LeaveDropdown", "DailyTimeRecord")',
                              data: { filteryear : _year},
                                 
                              success: function (response) {
                                  if (response.success) {

                                            var now = new Date();
                                            var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                                                              "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                                            var currentMonth = monthNames[now.getMonth()] + "-" + now.getFullYear();
                                         
                                                                       
                                       var tbodytableVL = $("#tblVL");
                                                tbodytableVL.empty();

                                                if (response.data.vlSummaries.length > 0) {
                                                            let totalCreditVL = 0;
                                                            let totalAvailedVL = 0;
                                                            let totalMonetizedVL = 0;

                                                    $.each(response.data.vlSummaries, function(index, item) {
                                                           var highlightClass = (item.asOf === currentMonth) ? "table-success" : "";

                                                                 totalCreditVL += parseFloat(item.credit) || 0;
                                                                totalAvailedVL += parseFloat(item.availed) || 0;
                                                                totalMonetizedVL += parseFloat(item.monetized) || 0;

                                                                    var row = `<tr class="${highlightClass}">
                                                                            <td><strong>${item.asOf}</strong></td>
                                                                            <td><strong>${parseFloat(item.begBal).toFixed(4)}</strong></td>
                                                                            <td>${parseFloat(item.credit).toFixed(4)}</td>
                                                                            <td><strong>${parseFloat(item.availed).toFixed(4)}</strong></td>
                                                                            <td><strong>${parseFloat(item.monetized).toFixed(4)}</strong></td>
                                                                            <td>${parseFloat(item.endBal).toFixed(4)}</td>
                                                                        </tr>`;
                                                        tbodytableVL.append(row);
                                                    });
                                                     
                                                            const totalRow = `
                                                                <tr style="font-weight:bold;">
                                                                    <td></td>
                                                                    <td></td>
                                                                    <td>${totalCreditVL.toFixed(4)}</td>
                                                                    <td>${totalAvailedVL.toFixed(4)}</td>
                                                                    <td>${totalMonetizedVL.toFixed(4)}</td>
                                                                    <td></td>
                                                                </tr>`;
                                                            tbodytableVL.append(totalRow);
                                                }

                                                  var tbodytableSL = $("#tblSL");
                                                tbodytableSL.empty();
                                                if (response.data.slSummaries.length > 0) {
                                                            let totalCreditSL = 0;
                                                            let totalAvailedSL = 0;
                                                            let totalMonetizedSL = 0;

                                                    $.each(response.data.slSummaries, function(index, item) {
                                                         var highlightClass = (item.asOf === currentMonth) ? "table-success" : "";

                                                              totalCreditSL += parseFloat(item.credit) || 0;
                                                                totalAvailedSL += parseFloat(item.availed) || 0;
                                                                totalMonetizedSL += parseFloat(item.monetized) || 0;

                                                             var row = `<tr class="${highlightClass}">
                                                                            <td><strong>${item.asOf}</strong></td>
                                                                            <td><strong>${parseFloat(item.begBal).toFixed(4)}</strong></td>
                                                                            <td>${parseFloat(item.credit).toFixed(4)}</td>
                                                                            <td><strong>${parseFloat(item.availed).toFixed(4)}</strong></td>
                                                                            <td><strong>${parseFloat(item.monetized).toFixed(4)}</strong></td>
                                                                            <td>${parseFloat(item.endBal).toFixed(4)}</td>
                                                                        </tr>`;
                                                        tbodytableSL.append(row);
                                                    });

                                                         const totalRow = `
                                                                <tr style="font-weight:bold;">
                                                                    <td></td>
                                                                    <td></td>
                                                                    <td>${totalCreditSL.toFixed(4)}</td>
                                                                    <td>${totalAvailedSL.toFixed(4)}</td>
                                                                    <td>${totalMonetizedSL.toFixed(4)}</td>
                                                                    <td></td>
                                                                </tr>`;
                                                            tbodytableSL.append(totalRow);
                                                }



                                  } else {
                                      Swal.fire({
                                          text: response.message,
                                          icon: "error"
                                      });
                                  }
                                  $('.spinner-overlay').hide();
                              },
                              error: function () {
                                  $('.spinner-overlay').hide();
                                  Swal.fire({
                                      text: "An error occurred. Please try again.",
                                      icon: "error"
                                  });
                              }
                          });                        
        }
    </script>
}