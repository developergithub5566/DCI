@model IEnumerable<DCI.Models.ViewModel.DocumentViewModel>
@using Newtonsoft.Json;
@using DCI.Core.Common;
@using DCI.Models.ViewModel;

<link href="~/css/DCIcustom.css" rel="stylesheet" />
<style>
    /* Hide the default file input */
    /* 	#fileUpload {
    display: none;
    } */

    /* Style the custom button */

    .custom-file-label {
    padding: 8px 16px;
    background-color: #007bff;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    }

    .file-name {
    margin-left: 10px;
    font-style: italic;
    }

</style>

@{
    var modulePageAccess = Context.Session.GetString("ModulePageAccess");

    var canView = false;
    var canAdd = false;
    var canEdit = false;
    var canDelete = false;
    var canExport = false;

    if (modulePageAccess == null)
    {
        <script>
            $.ajax({
            type: 'POST',
            url: '@Url.Action("Logout", "Account")',
            success: function (response) {

            Swal.fire({
            text: "Your session has timed out. Please log in again.",
            icon: "info",
            confirmButtonText: "Ok"
            }).then((result) => {
            window.location.href = '/Account/Logout';
            });
            },
            error: function () {
            Swal.fire({
            text: "An error occurred. Please try again.",
            icon: "error"
            });
            }
            })
        </script>
    }
    else
    {
        var module = JsonConvert.DeserializeObject<List<ModuleInRoleViewModel>>(modulePageAccess)?
                        .FirstOrDefault(x => x.ModulePageId == (int)EnumModulePage.Document);
        canView = module?.View ?? false;
        canAdd = module?.Add ?? false;
        canEdit = module?.Update ?? false;
        canDelete = module?.Delete ?? false;
        canExport = module?.Export ?? false;
    }
}

<div class="container-fluid">
    <div class="spinner-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>



    <div class="d-sm-flex align-items-center justify-content-between mb-3">
        <h6 class="m-0 font-weight-bold text-gray-800">Document</h6>
        <div class="upperRightDivBtn">
            <a href="#" title="Add Document" class="btn btnPrimary btn-icon-split @(canAdd ? "" : "disabled")" data-toggle="modal" data-target="#" onclick="newForm()">
                <span class="icon text-white"><i class="fa-solid fa-plus text-xs"></i></span>
                <span class="text text-white"><small>Add Document</small></span>
            </a>

        </div>

    </div>
    <div class="col-12 p0">
        <ul class="breadcrumb">
            <li><a href="~/Home/Index">Dashboard</a></li>
            <li>Document</li>
        </ul>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header">
            <label class="mb0">Data</label>
        </div>
        <div class="card-body">
            <div class="table-responsive mt20">
                <table class="table table-bordered nowrap" id="tblDocument" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            @* 	<th>
                            <label>Id</label>
                            </th> *@
                            <th>
                                <label>Document No</label>
                            </th>
                            <th>
                                <label>Document Name</label>
                            </th>
                            <th>
                                <label>Document Type</label>
                            </th>
                           
                            <th>
                                <label>Status</label>
                            </th>
                            <th>
                                <label>Date Created</label>
                            </th>
                            <th>
                                <label>Requested By</label>
                            </th>
                            <th>
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                @* <td>
                            @item.DocId
                            </td> *@
                                <td>
                                    @item.DocNo
                                </td>
                                <td class="col-2">
                                    @*    <span class="d-inline-block text-truncate" style="width: 150px;" title="@item.DocName"> *@
                                    <span class="d-inline-block text-truncate" style="width: 200px;" title="@item.DocName">
                                        @item.DocName
                                    </span>
                                </td>
                                <td>
                                    @item.DocTypeName
                                </td>
                                <td>
                                    @item.StatusName
                                </td>
                                <td>
                                    @item.DateCreated.ToShortDateString()
                                </td>
                               
                                <td>
                                    @item.RequestedName
                                </td>

                                <td>
                                    <a href="#" onclick="editForm(@item.DocId,1)" title="View" class="btn btn-primary @(canView ? "" : "disabled") "><i class="fas fa-search"></i></a> |
                                    <a href="#" id="editForm" onclick="editForm(@item.DocId,0)" title="Update" class="btn btn-info @(canEdit ? "" : "disabled") "><i class="fa fa-edit"></i></a> |
                                    <a href="#" id="deleteform" onclick="deleteform(@item.DocId)" title="Delete" class="btn btn-danger @(canDelete ? "" : "disabled") "><i class="far fa-trash-alt"></i></a>
                                    <a asp-controller="Document" asp-action="ApprovalHistory" asp-route-docid="@item.DocId" class="btn btn-success">
                                        <i class="fa fa-info-circle"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            </<div>
            </div>

            <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" id="createmodal">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Document</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form id="createForm">
                            <div class="modal-body">
                                <input type="hidden" id="DocId" name="DocId">

                                <div id="blobpdf" hidden></div>
                                <div id="pdfBinary" hidden></div>
                                <div id="qrcode" hidden></div>                              
                                <input type="text" class="form-control" id="canExport" name="canExport" value="@canExport" hidden >

                                <div class="row">
                                    <div class="col" id="DocNoDiv">
                                        <label for="DocNo" class="col-form-label">Document No:</label>
                                        <input type="text" class="form-control" id="DocNo" name="DocNo" readonly>
                                    </div>
                                    <div class="col">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label for="DocName" class="col-form-label">Document Name:</label>
                                        <input type="text" class="form-control" id="DocName" name="DocName" maxlength="255" required>
                                    </div>
                                    <div class="col">
                                        <label for="DocTypeId" class="col-form-label required">Document Type:</label>
                                        <select id="documentSelect" class="form-select" required>
                                            <option value="">select type</option>
                                        </select>
                                    </div>

                                </div>
                                <div class="row">

                                    <div class="col">
                                        <label for="Department" class="col-form-label required">Department:</label>
                                        <select id="departmentSelect" class="form-select" required>
                                            @*onchange="getSectionOnChange()"*@
                                            <option value="">select department</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <label for="DocCategory" class="col-form-label required">Document Category:</label>
                                        <select id="docCategorySelect" class="form-select" required>
                                            <option value="0">select type</option>
                                            <option value="1">Internal</option>
                                            <option value="2">Internal/External</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    @* 		<div class="col">
                                    <label for="Section" class="col-form-label required">Section:</label>
                                    <select id="sectionSelect" class="form-select" required>
                                    <option value="">select section</option>
                                    </select>
                                    </div> *@

                                    <div class="col">
                                        <label for="RequestById" class="col-form-label required">Request By:</label>
                                        <select id="requestBySelect" class="form-select" required>
                                            <option value="">select requestor</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <label for="DocLabel" id="DocLabel" class="col-form-label">Forms/Process:</label>
                                        <select id="FormsProcessSelect" class="form-select">
                                            <option value="0">select forms/process</option>
                                            <option value="1">Forms</option>
                                            <option value="2">Process</option>
                                        </select>
                                    </div>

                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label for="fileUpload" class="col-form-label">File Upload:</label>
                                        <br id="nextline" />
                                        <input type="file" class="form-control" id="fileUpload" name="fileUpload" accept="application/pdf" onchange="validateFileType()" />



                                        <a asp-controller="Document" asp-action="ViewDocument" asp-route-id="0" id="viewFile" target="_blank" title="View"><span class="file-name">No file chosen</span></a>
                                        @* <a asp-controller="Document" asp-action="ViewDocument" asp-route-id="0" id="viewFile" target="_blank" class="btn btn-primary" title="View">  <i class="fa fa-download"></i></a> *@
                                        @* <a href="#" id="deleteFile" onclick="removefile()" class="btn btn-danger" title="remove"> <i class="far fa-trash-alt"></i></a> *@
                                    </div>
                                    <div class="col">
                                    </div>
                                </div>

                                @*          <hr />

                                <div class="row">
                                <div class="col">
                                <label for="Reviewer" id="ReviewerLabel" class="col-form-label">Reviewer:</label>
                                <select id="reviewerSelect" class="form-select">
                                <option value="">select reviewer</option>
                                </select>
                                </div>
                                <div class="col" >
                                <label for="Approver" id="ApproverLabel" class="col-form-label">Approver:</label>
                                <select id="approverSelect" class="form-select">
                                <option value="">select approver</option>
                                </select>
                                </div>
                                </div> *@

                                <iframe id="pdfViewer" width="100%" height="600px" enctype="multipart/form-data" hidden>
                                    <input type="file" id="finalOutputPDF" name="finalOutputPDF">
                                </iframe>


                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary" id="btnSubmit">Submit</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>


        @section scripts {
            @* <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"></script> *@
            <script src="https://cdn.datatables.net/2.1.2/js/dataTables.js"></script>

            <script src="~/js/file-upload.js"></script>
            <script src="https://cdn.datatables.net/buttons/3.2.1/js/dataTables.buttons.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
            <script src="https://cdn.datatables.net/buttons/3.2.1/js/buttons.html5.min.js"></script>
            <script src="https://cdn.datatables.net/buttons/3.2.1/js/buttons.print.min.js"></script>
            <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.css">
            <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.1/css/buttons.dataTables.css">

            <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
            <script src="https://unpkg.com/pdf-lib@1.4.0"></script>
            <script src="https://unpkg.com/downloadjs@1.4.7"></script>

            <script type="text/javascript">
                const { degrees, PDFDocument, rgb, StandardFonts } = PDFLib

                var js = jQuery.noConflict(true);

                $('.spinner-overlay').show();

                setTimeout(() => {
                    $('.spinner-overlay').hide();
                }, 200);

                $(document).ready(function () {



                      var table =  js('#tblDocument').DataTable({
                    dom: '<"d-flex flex-column"<"d-flex justify-content-between align-items-center mb-2"B><"d-flex justify-content-between align-items-center"l<f>>>rtip',
                    buttons: [
                        {
                            extend: 'excel',
                            text: 'Excel',
                            title: 'Document Report',
                            exportOptions: {
                                columns: ':not(:last-child)' // Excludes the last column
                            }
                        },
                        {
                            extend: 'pdf',
                            text: 'PDF',
                            title: 'Document Report',
                            exportOptions: {
                                columns: ':not(:last-child)' // Excludes the last column
                            }
                        }
                    ],
                    lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ], // Entries per page
                    pageLength: 10 // Default entries per page
                });




                 const _export =  $('#canExport').val();
                

                if(_export == 0){
                        table.buttons(0).container().hide(); // Excel
                        table.buttons(1).container().hide(); // PDF
                }


                    // $("dt-button buttons-excel buttons-html5").addClass("hide");
                    //  $("dt-button buttons-pdf buttons-html5").addClass("hide");

                    //document.getElementById("FormsProcessSelect").style.display = 'none';

                    //document.getElementById("DocLabel").style.display = 'none';

                    $('#fileUpload').on('change', function () {
                        var fileName = this.files[0] ? this.files[0].name : 'No file chosen';
                        document.querySelector('.file-name').textContent = '';

                        const newrecord = $('#DocId').val();

                        if (newrecord != 0) {
                            $('.file-name').text(fileName);
                        }
                    });

                    $('#createForm').submit(function (event) {
                        event.preventDefault();
                        const fileInput = document.getElementById('fileUpload');
                        const file = fileInput.files[0]; // Get the first selected file
                        const docId = $('#DocId').val();
                        const docNo = $('#DocNo').val();
                        const docName = $('#DocName').val();
                        const doctypeId = $('#documentSelect').val();
                        const deptId = $('#departmentSelect').val();
                        const docCatId = $('#docCategorySelect').val();
                        //const sectionId = $('#sectionSelect').val();
                        const formsProcess = $('#FormsProcessSelect').val();

                        const requestById = $('#requestBySelect').val();
                        const reviewer = $('#reviewerSelect').val();
                        const approver = $('#approverSelect').val();

                        // var formData = $(this).serialize();
                        const formData = new FormData();
                        formData.append('DocId', docId);
                        formData.append('DocNo', docNo);
                        formData.append('DocName', docName);
                        formData.append('DocTypeId', doctypeId);
                        formData.append('DepartmentId', deptId);
                        formData.append('DocCategory', docCatId);
                        formData.append('RequestById', requestById);
                        formData.append('Reviewer', reviewer);
                        formData.append('Approver', approver);
                        //formData.append('SectionId', sectionId);

                        formData.append('FormsProcess', formsProcess);

                        formData.append('DocFile', file);

                        //QRCode and PDF
                        let textQRCode = $('#FileLocation').val() + docId;
                        var qrcode = new QRCode("qrcode");
                        qrcode.makeCode(textQRCode);
                        let qrCanvas = document.querySelector("#qrcode canvas"); // Get QR canvas
                        let imgData = qrCanvas.toDataURL("image/png");
                        let qrFile = base64ToFile(imgData, "QRCode.png");
                        let QRCodebase64String = imgData.split(",")[1];
                        formData.append('QRCodeImage', qrFile);
                        const pdfBinaryX = $('#pdfBinary').val();
                        InsertQRCodeInPDF(pdfBinaryX, QRCodebase64String)

                        setTimeout(() => {

                            formData.append('FinalOutputPDF', $('#blobpdf').val(), fileInput.files[0].name);


                            Swal.fire({
                                text: "Are you sure you want to save this record?",
                                icon: "question",
                                showCancelButton: true,
                                confirmButtonText: "Ok"
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    $('.spinner-overlay').show();

                                    $.ajax({
                                        type: 'POST',
                                        url: '@Url.Action("SaveDocument", "Document")',
                                        data: formData,
                                        processData: false,
                                        contentType: false,
                                        success: function (response) {
                                            if (response.success) {
                                                $('#createForm')[0].reset();
                                                js('#createmodal').modal('hide');

                                                Swal.fire({
                                                    text: response.message,
                                                    icon: "success",
                                                    confirmButtonText: "Ok"
                                                }).then((result) => {
                                                    location.reload();
                                                });

                                            } else {
                                                Swal.fire({
                                                    text: response.message,
                                                    icon: "error"
                                                });
                                            }
                                            $('.spinner-overlay').hide();
                                        },
                                        error: function () {
                                            $('.spinner-overlay').hide();
                                            Swal.fire({
                                                text: "An error occurred. Please try again.",
                                                icon: "error"
                                            });
                                        }
                                    });
                                }
                            });
                        }, 1000);
                    });// submit

                    document.getElementById("fileUpload").addEventListener("change", function (event) {
                        let file = event.target.files[0]; // Get the selected file
                        if (file) {
                            let reader = new FileReader();
                            reader.readAsDataURL(file); // Read the file as Data URL (Base64)

                            reader.onload = function () {
                                let base64String = reader.result.split(",")[1]; // Extract only the Base64 content
                                // console.log(base64String); // Display or send to backend
                                document.getElementById("pdfBinary").value = base64String;
                            };

                            reader.onerror = function (error) {
                                console.error("Error reading file: ", error);
                            };
                        }
                    });

                });

                function newForm() {
                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("EditDocument", "Document")',
                        success: function (response) {
                            console.log(response.data);
                            if (response.success) {
                                $('#DocId').val("0");
                                $('#DocNo').val("");
                                $('#DocName').val("");
                                //js('#docCategorySelect').val('0');
                                //document.getElementById('docCategorySelect').value = '0'
                                // var leaveCode = document.querySelector('#docCategorySelect');
                                // leaveCode[i].selected = true;
                                document.getElementById("docCategorySelect").selectedIndex = "0";
                                //document.getElementById("sectionSelect").selectedIndex = "0";

                                document.getElementById("FormsProcessSelect").selectedIndex = "0";


                                //$('#sectionSelect').val(0);
                                $('#RequestById').val(0);
                                // $('#Reviewer').val(0);
                                // 		$('#Approver').val(0);
                                $('#DocTypeId').val(0);

                                const input = document.querySelector('#fileUpload')
                                input.value = '';

                                var $select = $('#documentSelect');
                                $select.empty();
                                $select.append('<option value="">Select type</option>');

                                $.each(response.data.optionsDocumentType, function (index, item) {
                                    if (item.value == response.data.docTypeId) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                                var $select = $('#departmentSelect');
                                $select.empty();
                                $select.append('<option value="">Select type</option>');

                                $.each(response.data.optionsDepartment, function (index, item) {
                                    if (item.value == response.data.departmentId) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                                var $select = $('#requestBySelect');
                                $select.empty();
                                $select.append('<option value="">select requestor</option>');

                                $.each(response.data.optionsRequestBy, function (index, item) {
                                    if (item.value == response.data.requestBy) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                                var $select = $('#reviewerSelect');
                                $select.empty();
                                $select.append('<option value="">select reviewer</option>');

                                $.each(response.data.optionsReviewer, function (index, item) {
                                    if (item.value == response.data.reviewer) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                                var $select = $('#approverSelect');
                                $select.empty();
                                $select.append('<option value="">select approver</option>');

                                $.each(response.data.optionsApprover, function (index, item) {
                                    if (item.value == response.data.approver) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });


                                $('#DocNoDiv').hide();
                                document.querySelector('.file-name').textContent = '';
                                $('#fileUpload').show();
                                $('#viewFile').hide();
                                $('#deleteFile').hide();
                                $('#btnSubmit').show();
                                $('#createForm').find('input, select, textarea').prop('disabled', false);;
                                $('#fileUpload').prop('disabled', false);
                                js('#createmodal').modal('show');
                            } else {
                                Swal.fire({
                                    text: response.message,
                                    icon: "error"
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                text: "An error occurred. Please try again.",
                                icon: "error"
                            });
                        }
                    });
                }

                function editForm(id, view) {

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("EditDocument", "Document")',
                        data: { DocId: id },
                        success: function (response) {
                            //	console.log(response.data);
                            if (response.success) {
                                $('#DocId').val(response.data.docId);
                                $('#DocNo').val(response.data.docNo);
                                $('#DocName').val(response.data.docName);
                                $('#DocTypeId').val(response.data.docTypeId);
                                $('#docCategorySelect').val(response.data.docCategory)
                                //$('#sectionSelect').val(response.data.sectionId
                                $('#FormsProcessSelect').val(response.data.formsProcess)
                                // $('#RequestById').val(response.data.requestById)
                                // $('#SectionId').val(response.data.sectionId)

                                var $select = $('#documentSelect');
                                $select.empty();
                                $select.append('<option value="">Select type</option>');
                                $.each(response.data.optionsDocumentType, function (index, item) {
                                    if (item.value == response.data.docTypeId) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                                var $select = $('#departmentSelect');
                                $select.empty();
                                $select.append('<option value="">Select department</option>');
                                $.each(response.data.optionsDepartment, function (index, item) {
                                    if (item.value == response.data.departmentId) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                                // var $select = $('#sectionSelect');
                                // $select.empty();
                                // $select.append('<option value="">Select section</option>');
                                // $.each(response.data.optionsSection, function (index, item) {
                                // 	if (item.value == response.data.sectionId) {
                                // 		$select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                // 	} else {
                                // 		$select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                // 	}
                                // });



                                var $select = $('#requestBySelect');
                                $select.empty();
                                $select.append('<option value="">Select requestor</option>');

                                $.each(response.data.optionsRequestBy, function (index, item) {
                                    if (item.value == response.data.requestById) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                                var $select = $('#reviewerSelect');
                                $select.empty();
                                $select.append('<option value="">select reviewer</option>');

                                $.each(response.data.optionsReviewer, function (index, item) {
                                    if (item.value == response.data.reviewer) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                                var $select = $('#approverSelect');
                                $select.empty();
                                $select.append('<option value="">select approver</option>');

                                $.each(response.data.optionsApprover, function (index, item) {
                                    if (item.value == response.data.approver) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                                var linkElement = document.getElementById("viewFile");
                                linkElement.setAttribute('href', '/Document/ViewDocument?DocId=' + response.data.docId);

                                document.querySelector('.file-name').textContent = response.data.filename;

                                $('#DocNoDiv').show();
                                if (view == 1) {	//View button

                                    $('#createForm').find('input, select, textarea').prop('disabled', true);
                                    js('#createmodal').modal('show');
                                    $('#btnSubmit').hide();
                                    $('#deleteFile').hide();
                                }
                                else {  //Edit button
                                    $('#createForm').find('input, select, textarea').prop('disabled', false);;
                                    $('#fileUpload').prop('disabled', false);
                                    $('#btnSubmit').show();
                                    $('#deleteFile').show();
                                }


                                if (response.data.filename != '') { //if file exist
                                    $('#fileUpload').hide();
                                    $('#viewFile').show();
                                } else {
                                    $('#fileUpload').show();
                                    $('#viewFile').hide();
                                    $('#deleteFile').hide();
                                }


                                //
                                // if (response.data.labelId < 2) {
                                // 	document.getElementById("FormsProcessSelect").style.display = 'none';
                                // 	document.getElementById("DocLabel").style.display = 'none';
                                // } else {
                                // 	document.getElementById("FormsProcessSelect").style.display = 'block';
                                // 	document.getElementById("DocLabel").style.display = 'block';
                                // }

                                js('#createmodal').modal('show');
                            } else {
                                Swal.fire({
                                    text: response.message,
                                    icon: "error"
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                text: "An error occurred. Please try again.",
                                icon: "error"
                            });
                        }
                    });
                }

                function deleteform(id) {

                    Swal.fire({
                        text: "Are you sure you want to delete this record?",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Yes, delete it!"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                type: 'POST',
                                url: '@Url.Action("DeleteDocument", "Document")',
                                data: { DocId: id },
                                success: function (response) {
                                    if (response.success) {
                                        Swal.fire({
                                            text: response.message,
                                            icon: "success",
                                            confirmButtonText: "Ok"
                                        }).then((result) => {
                                            location.reload();
                                        });
                                    } else {
                                        Swal.fire({
                                            text: response.message,
                                            icon: "error"
                                        });
                                    }
                                },
                                error: function () {
                                    Swal.fire({
                                        text: "An error occurred. Please try again.",
                                        icon: "error"
                                    });
                                }
                            });
                        }
                    });
                }

                function removefile() {

                    Swal.fire({
                        text: "Are you sure you want to delete this file?",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Yes, delete it!"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            document.querySelector('.file-name').textContent = '';
                            $('#fileUpload').show();
                            $('#viewFile').hide();
                            $('#deleteFile').hide();

                            // $('#fileUpload').on('change', function () {
                            // 	var fileName = this.files[0] ? this.files[0].name : 'No file chosen';
                            // 	$('.file-name').text(fileName);
                            // });
                        }
                    });
                }

                function getSectionOnChange() {
                    let deptId = document.getElementById("departmentSelect").value;

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("GetSectionByDepartmentId", "Maintenance")',
                        data: { DepartmentId: deptId },
                        success: function (response) {
                            if (response.success) {
                                console.log(response.data);

                                var $select = $('#sectionSelect');
                                $select.empty();
                                $select.append('<option value="">Select type</option>');
                                $.each(response.data.optionsSection, function (index, item) {
                                    if (item.value == response.data.sectionId) {
                                        $select.append('<option value="' + item.value + '" selected="selected">' + item.text + '</option>');
                                    } else {
                                        $select.append('<option value="' + item.value + '">' + item.text + '</option>');
                                    }
                                });

                            } else {
                                Swal.fire({
                                    text: response.message,
                                    icon: "error"
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                text: "An error occurred. Please try again.",
                                icon: "error"
                            });
                        }
                    });
                }

                function validateFileType() {
                    const input = document.getElementById('fileUpload');
                    const file = input.files[0];

                    if (file) {
                        if (file.type !== "application/pdf") {
                            input.value = '';
                            Swal.fire({
                                text: "Invalid file type. Please select a PDF file.",
                                icon: "error"
                            });
                        }
                    }
                }

                // function getCategoryOnChange() {
                // 	let catId = document.getElementById("docCategorySelect").value;

                // 	if (catId < 2){

                // 		document.getElementById("FormsProcessSelect").style.display = 'none';
                // 		document.getElementById("DocLabel").style.display = 'none';
                // 	}else{
                // 		document.getElementById("FormsProcessSelect").style.display = 'block';
                // 		document.getElementById("DocLabel").style.display = 'block';
                // 	}
                // }
                async function InsertQRCodeInPDF(PdfBase64, QRbase64x) {
                    console.log("InsertQRCodeInPDF");
                    console.log(QRbase64x);
                    const dataUri = 'data:application/pdf;base64,' + PdfBase64
                    const QRdataUri = 'data:image/png;base64,' + QRbase64x
                    const pdfDoc = await PDFDocument.load(dataUri)
                    const jpgImageBytes = await fetch(QRdataUri).then((res) => res.arrayBuffer())
                    const pages = pdfDoc.getPages()
                    const firstPage = pages[0]
                    const jpgImage = await pdfDoc.embedPng(jpgImageBytes)
                    const { width, height } = firstPage.getSize()
                    const logoWidth = 100;
                    const logoHeight = 100;
                    const pngDims = jpgImage.scale(1);
                    const pageWidth = firstPage.getWidth();
                    const pageHeight = firstPage.getHeight();
                    firstPage.drawImage(jpgImage, {
                        x: pageWidth - logoWidth - 20,
                        y: 18, //pageHeight - logoHeight - 20 important upper right
                        width: logoWidth,
                        height: logoHeight,
                    });

                    const pdfBytes = await pdfDoc.save()

                    const blob = new Blob([pdfBytes], { type: "application/pdf" });
                    const url = URL.createObjectURL(blob);
                    document.getElementById("pdfViewer").src = url;

                    $('#blobpdf').val(blob);

                }


                function base64ToFile(base64String, fileName) {
                    let arr = base64String.split(',');
                    let mime = arr[0].match(/:(.*?);/)[1]; // Extract MIME type
                    let bstr = atob(arr[1]); // Decode Base64
                    let n = bstr.length;
                    let u8arr = new Uint8Array(n);
                    while (n--) {
                        u8arr[n] = bstr.charCodeAt(n);
                    }
                    return new File([u8arr], fileName, { type: mime });
                }
            </script>
        }
